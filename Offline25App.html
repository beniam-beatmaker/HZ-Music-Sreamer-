  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HZ Music Streamer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KPC9yYWRpYWxHcmFkaWVudD4KPC9kZWZzPgo8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNiIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2LDE2KSI+CjxnPgo8cGF0aCBkPSJNLTEwIDAgTDEwIDAiIHN0cm9rZT0iI0ZGRDQ0NCIgc3Ryb2tlLXdpZHRoPSIwLjUiIG9wYWNpdHk9IjAuOCIvPgo8cGF0aCBkPSJNMCAtMTAgTDAgMTAiIHN0cm9rZT0iI0ZGRDQ0NCIgc3Ryb2tlLXdpZHRoPSIwLjUiIG9wYWNpdHk9IjAuOCIvPgo8L2c+CjxnIHRyYW5zZm9ybT0icm90YXRlKDQ1KSI+CjxwYXRoIGQ9Ik0tOCAwIEw4IDAiIHN0cm9rZT0iI0ZGRjY2NiIgc3Ryb2tlLXdpZHRoPSIwLjMiIG9wYWNpdHk9IjAuNiIvPgo8cGF0aCBkPSJNMCAtOCBMMCA4IiBzdHJva2U9IiNGRkY2NjYiIHN0cm9rZS13aWR0aD0iMC4zIiBvcGFjaXR5PSIwLjYiLz4KPC9nPgo8ZyB0cmFuc2Zvcm09InJvdGF0ZSgyMi41KSI+CjxwYXRoIGQ9Ik0tNiAwIEw2IDAiIHN0cm9rZT0iI0ZGRjg4OCIgc3Ryb2tlLXdpZHRoPSIwLjIiIG9wYWNpdHk9IjAuNCIvPgo8cGF0aCBkPSJNMCAtNiBMMCA2IiBzdHJva2U9IiNGRkY4ODgiIHN0cm9rZS13aWR0aD0iMC4yIiBvcGFjaXR5PSIwLjQiLz4KPC9nPgo8ZyB0cmFuc2Zvcm09InJvdGF0ZSg2Ny41KSI+CjxwYXRoIGQ9Ik0tNiAwIEw2IDAiIHN0cm9rZT0iI0ZGRjg4OCIgc3Ryb2tlLXdpZHRoPSIwLjIiIG9wYWNpdHk9IjAuNCIvPgo8cGF0aCBkPSJNMCAtNiBMMCA2IiBzdHJva2U9IiNGRkY4ODgiIHN0cm9rZS13aWR0aD0iMC4yIiBvcGFjaXR5PSIwLjQiLz4KPC9nPgo8Y2lyY2xlIGN4PSIwIiBjeT0iMCIgcj0iMyIgZmlsbD0iI0ZGRjAwMCIgb3BhY2l0eT0iMC45Ii8+CjxjaXJjbGUgY3g9IjAiIGN5PSIwIiByPSIxLjUiIGZpbGw9IiNGRkZGRkYiIG9wYWNpdHk9IjAuOCIvPgo8L2c+Cjwvc3ZnPg==">
  <style>
    .like-btn-pop {
      animation: likePop 0.35s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes likePop {
      0% { transform: scale(1); }
      50% { transform: scale(1.4); }
      100% { transform: scale(1); }
    }

    /* Glittering star animation for like button */
    .like-btn-glitter {
      animation: likeGlitter 0.8s ease-out both;
    }
    @keyframes likeGlitter {
      0% {
        transform: scale(1);
        filter: drop-shadow(0 0 0px rgba(255,0,0,0));
      }
      25% {
        transform: scale(1.2);
        filter: drop-shadow(0 0 8px rgba(255,0,0,0.6)) drop-shadow(0 0 15px rgba(255,255,255,0.3));
      }
      50% {
        transform: scale(1.1);
        filter: drop-shadow(0 0 12px rgba(255,0,0,0.8)) drop-shadow(0 0 20px rgba(255,255,255,0.5));
      }
      75% {
        transform: scale(1.15);
        filter: drop-shadow(0 0 6px rgba(255,0,0,0.4)) drop-shadow(0 0 12px rgba(255,255,255,0.2));
      }
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 0px rgba(255,0,0,0));
      }
    }

    /* Sparkle particles */
    .sparkle {
      position: absolute;
      pointer-events: none;
      width: 4px;
      height: 4px;
      background: #fff;
      border-radius: 50%;
      animation: sparkleFloat 1s ease-out forwards;
    }
    @keyframes sparkleFloat {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(0);
      }
      50% {
        opacity: 1;
        transform: translate(var(--dx), var(--dy)) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(calc(var(--dx) * 2), calc(var(--dy) * 2)) scale(0);
      }
    }

    /* Drag to open functionality */
    .sticky-player-dragging {
      transform: translateY(-10px);
      box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
      transition: none !important;
    }

    .drag-indicator {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: #b3b3b3;
      border-radius: 2px;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .sticky-player:hover .drag-indicator {
      opacity: 1;
      background: #1db954;
    }

    /* --- Professional, Appealing, Unified CSS --- */

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #181818;
  color: #fff;
  margin: 0;
}


header {
  position: sticky;
  top: 0;
  background: #121212;
  padding: 1rem 2rem;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.logo-btn {
  font-size: 1.7rem;
  font-weight: bold;
  color: #1db954;
  background: transparent;
  border: 2px solid #1db954;
  border-radius: 30px;
  padding: 0.4rem 1.6rem;
  text-decoration: none;
  letter-spacing: 2px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.logo-btn:hover, .logo-btn:focus {
  background: #0066ff;
  color: #fff;
  border-color: #0066ff;
  outline: none;
}

nav {
  display: flex;
  gap: 1rem;
}
nav a {
  text-decoration: none;
  color: #fff;
  background: #232526;
  padding: 0.6rem 1.4rem;
  border-radius: 30px;
  font-weight: 500;
  transition: background 0.2s, color 0.2s;
  border: 2px solid transparent;
}
nav a:hover, nav a.active {
  background: #1db954;
  color: #181818;
  border-color: #1db954;
}

.mobile-menu-btn {
  display: none;
  background: none;
  border: 2px solid #1db954;
  color: #1db954;
  font-size: 1.5rem;
  padding: 0.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}
.mobile-menu-btn:hover {
  background: #0066ff;
  color: #fff;
  border-color: #0066ff;
}

/* Change the mobile menu button (?) to gold background with black lines */
.mobile-menu-btn {
  background: gold !important;
  color: black !important;
  border-color: gold !important;
  display: none !important; /* Hide old mobile menu */
}
.mobile-menu-btn:hover,
.mobile-menu-btn:focus {
  background: #ffd700 !important;
  color: black !important;
  border-color: #ffd700 !important;
}

.mobile-nav {
  display: none !important; /* Hide old mobile nav completely */
  position: absolute;
  top: calc(100% + 10px);
  left: 0;
  background: linear-gradient(135deg, #232526 0%, #181818 100%);
  border-radius: 15px;
  padding: 1rem;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
  z-index: 3002;
  min-width: 250px;
  backdrop-filter: blur(10px);
  border: 1px solid #404040;
}
.mobile-nav.active {
  display: block !important;
}
.mobile-nav .nav-btn {
  width: 100%;
  margin: 0.2rem 0;
  font-size: 0.9rem;
  text-align: left;
  padding: 0.6rem 1rem;
  border-radius: 10px;
  background: linear-gradient(45deg, #1db954, #1ed760);
  color: #fff;
  border: none;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(29, 185, 84, 0.2);
  text-decoration: none;
}
.mobile-nav .nav-btn:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(29, 185, 84, 0.4);
}
.mobile-nav .nav-btn.active {
  background: linear-gradient(45deg, #0066ff, #4d94ff);
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.2);
}
.mobile-nav .nav-btn.active:hover {
  box-shadow: 0 4px 12px rgba(0, 102, 255, 0.4);
}

/* Hamburger Menu Styles */
.hamburger-menu {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 2000;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.hamburger-menu:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
}

.hamburger-line {
    width: 20px;
    height: 2px;
    background: #000;
    border-radius: 1px;
    transition: all 0.3s ease;
}

.hamburger-menu.active .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.hamburger-menu.active .hamburger-line:nth-child(2) {
    opacity: 0;
}

.hamburger-menu.active .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
}

/* Navigation Dropdown */
.nav-dropdown {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 1900;
    background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
    border-radius: 15px;
    padding: 1rem;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 2px solid #404040;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
}

.nav-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.nav-dropdown .nav-btn {
    display: block;
    width: 100%;
    margin-bottom: 0.5rem;
    text-align: left;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background: transparent;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #fff;
    font-size: 0.95rem;
    font-weight: 600;
}

.nav-dropdown .nav-btn:last-child {
    margin-bottom: 0;
}

.nav-dropdown .nav-btn:hover {
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: #000;
    transform: translateX(5px);
    border-color: #FFD700;
}

.nav-dropdown .nav-btn.active {
    background: linear-gradient(45deg, #0066ff, #4d94ff);
    color: #fff;
    border-color: #0066ff;
}

.nav-dropdown .nav-btn.active:hover {
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: #000;
    border-color: #FFD700;
}
.mobile-nav .close-btn {
  display: none;
}

.spacer { height: 20px; }

.feature-container {
  max-width: 650px;
  margin: 3rem auto;
  background: #232526;
  padding: 2rem 2.5rem;
  border-radius: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
}

h2 {
  margin-bottom: 1.5rem;
  font-size: 2rem;
  font-weight: 700;
  color: #fff;
  letter-spacing: 1px;
}
.desc {
  color: #b3b3b3;
  font-size: 1.1rem;
  margin-bottom: 1.5rem;
}

.upload-section {
  margin-top: 2rem;
}

input[type="file"] {
  margin-top: 1rem;
  background: #232526;
  color: #fff;
  border: 1px solid #1db954;
  border-radius: 8px;
  padding: 0.5rem;
}

.search-bar {
  margin: 2rem 0 1rem 0;
  display: flex;
  gap: 1rem;
}
.search-bar input {
  flex: 1;
  padding: 0.7rem;
  border-radius: 20px;
  border: none;
  font-size: 1rem;
  background: #181818;
  color: #fff;
}
.search-bar button {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #000;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}
.search-bar button:hover {
  background: linear-gradient(135deg, #FFA500, #FF8C00);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
}

#searchBtn:hover {
  background: linear-gradient(135deg, #FFA500, #FF8C00) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4) !important;
}

.offline-list {
  margin-top: 2rem;
  background: #232526;
  border-radius: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  padding: 1rem;
  max-height: 500px;
  overflow-y: auto;
  scroll-behavior: smooth;
}
.offline-list::-webkit-scrollbar {
  width: 6px;
}
.offline-list::-webkit-scrollbar-track {
  background: #181818;
  border-radius: 3px;
}
.offline-list::-webkit-scrollbar-thumb {
  background: #1db954;
  border-radius: 3px;
}
.offline-list::-webkit-scrollbar-thumb:hover {
  background: #0066ff;
}

.offline-track {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.8rem;
  background: #181818;
  border-radius: 8px;
  padding: 0.8rem 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.2s;
  border: 1px solid transparent;
}
.offline-track:hover {
  background: #232526;
  border-color: #1db954;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.offline-track .track-title {
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  margin-right: 1.2rem;
}
.offline-track .track-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.offline-track .track-actions button {
  background: #1db954;
  color: #181818;
  border: none;
  border-radius: 20px;
  padding: 0.2rem 1rem;
  font-size: 0.95rem;
  cursor: pointer;
  margin-right: 0.5rem;
  transition: background 0.2s, color 0.2s;
}
.offline-track .track-actions button:hover {
  background: #0066ff;
  color: #fff;
}
.offline-track .like-btn {
  background: none;
  border: none;
  color: #ff4081;
  font-size: 1.3em;
  vertical-align: middle;
  cursor: pointer;
  margin-left: 0.3rem;
  transition: color 0.2s;
}
.offline-track input[type="checkbox"] {
  accent-color: #1db954;
  margin-right: 0.7rem;
  width: 1.1em;
  height: 1.1em;
}

/* --- Video Library Styles --- */
.offline-video-list {
  scrollbar-width: thin;
  scrollbar-color: #1db954 #333;
}
.offline-video-list::-webkit-scrollbar {
  width: 6px;
}
.offline-video-list::-webkit-scrollbar-track {
  background: #333;
  border-radius: 3px;
}
.offline-video-list::-webkit-scrollbar-thumb {
  background: #1db954;
  border-radius: 3px;
}
.offline-video-list::-webkit-scrollbar-thumb:hover {
  background: #0066ff;
}

.video-item {
  position: relative;
  margin-bottom: 1rem;
  border-radius: 8px;
  overflow: hidden;
  background: #181818;
  border: 1px solid transparent;
  transition: all 0.2s;
}

.video-item:hover {
  border-color: #1db954;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.video-square {
  position: relative;
  width: 100%;
  height: 120px;
  background: #232526;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.video-square video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  object-position: center center;
  background: #000;
  z-index: 2;
  position: relative;
}

.video-square video:not([data-loaded="true"]) + .video-fallback {
  display: flex;
}

.video-square video[data-loaded="true"] + .video-fallback {
  display: none;
}

.video-play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(29, 185, 84, 0.9);
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  color: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.video-play-btn:hover {
  background: rgba(0, 102, 255, 0.9);
  transform: translate(-50%, -50%) scale(1.1);
}

.video-title {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.8));
  color: white;
  padding: 20px 10px 10px;
  font-size: 0.9rem;
  font-weight: 600;
}

.video-expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-width: 800px;
  background: #181818;
  border-radius: 12px;
  overflow: hidden;
  z-index: 2000;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  transition: all 0.3s ease;
}

.video-expanded.minimized {
  top: 120px;
  right: 20px;
  left: auto;
  transform: none;
  width: 320px;
  max-width: 320px;
  z-index: 1500;
  cursor: pointer;
}

.video-expanded.minimized:hover {
  box-shadow: 0 4px 16px rgba(29, 185, 84, 0.3);
}

.video-expanded video {
  width: 100%;
  height: 100%;
  max-height: 60vh;
  object-fit: contain;
  object-position: center center;
  background: #000;
}

.video-expanded.minimized video {
  max-height: 180px;
  object-fit: contain;
  object-position: center center;
  background: #000;
}

.video-close-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(128, 128, 128, 0.8);
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  color: white;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2001;
  transition: background 0.2s;
}

.video-close-btn:hover {
  background: rgba(128, 128, 128, 1);
}

.video-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.9));
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 1000;
  opacity: 1;
  visibility: visible;
  transition: all 0.3s ease;
}

.video-expanded.minimized .video-controls {
  padding: 8px 12px;
  gap: 8px;
}

.video-expanded.minimized .video-control-btn {
  padding: 6px 8px;
  font-size: 12px;
  min-height: 28px;
}

.video-expanded.minimized .video-volume-slider {
  width: 60px;
}

.video-control-btn {
  background: rgba(29, 185, 84, 0.9);
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  color: white;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  min-height: 36px;
  user-select: none;
  z-index: 1001;
}

.video-control-btn:hover {
  background: rgba(0, 102, 255, 0.9);
  transform: scale(1.05);
}

.video-control-btn:active {
  transform: scale(0.95);
}

.video-volume-slider {
  width: 100px;
  height: 6px;
  background: #333;
  border-radius: 3px;
  outline: none;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
}

.video-volume-slider::-webkit-slider-thumb {
  appearance: none;
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: 2px solid #fff;
}

.video-volume-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: 2px solid #fff;
}

.video-progress-slider {
  width: 100%;
  height: 6px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

.video-progress-slider::-webkit-slider-thumb {
  appearance: none;
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: 2px solid #fff;
}

.video-progress-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: 2px solid #fff;
  border: none;
}

.video-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1999;
  display: none;
}

/* YouTube-style minimized video player */
.video-mini-player {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 320px;
  height: 180px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  z-index: 2000;
  display: none;
  border: 2px solid #1db954;
  cursor: pointer;
}

.video-mini-player video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  object-position: center center;
  background: #000;
}

/* Center play/pause button - clean style */
.video-mini-play-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: none;
  border: none;
  color: white;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s;
  z-index: 10;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.video-mini-player:hover .video-mini-play-center {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1.1);
}

.video-mini-play-center:hover {
  transform: translate(-50%, -50%) scale(1.2) !important;
  text-shadow: 2px 2px 6px rgba(0,0,0,1);
}

/* Bottom-left mute button */
.video-mini-mute {
  position: absolute;
  bottom: 8px;
  left: 8px;
  background: none;
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s;
  z-index: 10;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.video-mini-player:hover .video-mini-mute {
  opacity: 1;
}

.video-mini-mute:hover {
  transform: scale(1.1);
  text-shadow: 2px 2px 6px rgba(0,0,0,1);
}

/* Fullscreen button in top-left - clean style */
.video-mini-fullscreen {
  position: absolute;
  top: 8px;
  left: 8px;
  background: none;
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s;
  z-index: 10;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.video-mini-player:hover .video-mini-fullscreen {
  opacity: 1;
}

.video-mini-fullscreen:hover {
  transform: scale(1.1);
  text-shadow: 2px 2px 6px rgba(0,0,0,1);
}

/* YouTube-style close button */
.video-close-mini {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(0, 0, 0, 0.8);
  border: none;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s;
  z-index: 10;
}

.video-mini-player:hover .video-close-mini {
  opacity: 1;
}

.video-close-mini:hover {
  background: rgba(0, 0, 0, 1);
  transform: scale(1.1);
}

/* Remove old controls bar */
.video-mini-controls {
  display: none;
}

.video-mini-btn {
  background: none;
  border: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.video-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  max-width: none !important;
  transform: none !important;
  border-radius: 0 !important;
  z-index: 2001;
}

.video-fullscreen video {
  max-height: 100vh !important;
}

.playlist-track-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  background: #232526;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.8rem 1.2rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.playlist-track-btn:hover {
  background: #0066ff !important;
  color: #fff !important;
}
.playlist-track-btn .like-btn:hover {
  color: #fff700 !important;
}

/* --- Online Browser --- */
.online-browser {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 350px;
  background: #232526;
  border-radius: 15px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 500;
  max-height: 80vh;
  overflow-y: auto;
}
@media (max-width: 1200px) {
  .online-browser { width: 300px; right: 10px; }
  .feature-container { margin-right: 320px; }
}
@media (max-width: 1000px) {
  .online-browser {
    position: relative;
    width: 100%;
    top: 0;
    right: 0;
    margin: 2rem 0;
  }
  .feature-container {
    margin-right: 0;
  }
}

/* --- Online Results --- */
#onlineResults {
  max-height: 400px;
  overflow-y: auto;
  scroll-behavior: smooth;
  background: #232526;
  border-radius: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  padding: 1rem;
}
#onlineResults::-webkit-scrollbar {
  width: 6px;
}
#onlineResults::-webkit-scrollbar-track {
  background: #181818;
  border-radius: 3px;
}
#onlineResults::-webkit-scrollbar-thumb {
  background: #1db954;
  border-radius: 3px;
}
#onlineResults::-webkit-scrollbar-thumb:hover {
  background: #0066ff;
}

/* --- Enhanced Spotify-like Sticky Player --- */
.sticky-player {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  min-height: 90px; /* Slightly taller for better Spotify feel */
  max-height: 90px;
  background: linear-gradient(90deg, #181818 0%, #121212 50%, #181818 100%);
  z-index: 1000;
  box-shadow: 0 -2px 20px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-top: 1px solid #282828;
  animation: stickyFadeIn 0.5s;
  box-sizing: border-box;
  gap: 16px;
  backdrop-filter: blur(20px);
}

.sticky-player::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, #1db954 50%, transparent 100%);
}

/* Rotating cover animation */
@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.rotating {
  animation: rotate 20s linear infinite;
}

.paused {
  animation-play-state: paused;
}

.sticky-player .player-main {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 0 0 30%;
  min-width: 0;
  cursor: pointer;
}

.sticky-player .player-cover {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: transparent;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sticky-player .player-cover .hz-circle {
  border-radius: 50%;
  transition: all 0.3s ease;
}

.sticky-player .player-cover:hover .hz-circle {
  transform: scale(1.05);
}

/* Sticky player rotation animation */
.sticky-player .player-cover.rotating .hz-circle {
  animation: rotateCover 20s linear infinite;
}

.sticky-player .player-cover.rotating.bass-pulse .hz-circle {
  animation: rotateCover 20s linear infinite, bassPulse 0.2s ease-out;
}

.sticky-player .player-meta {
  display: flex;
  flex-direction: column;
  min-width: 0;
  flex: 1;
  justify-content: center;
  gap: 2px;
}

.sticky-player .player-title {
  font-weight: 500;
  color: #fff;
  font-size: 14px;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.sticky-player .player-artist {
  font-size: 11px;
  color: #b3b3b3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.sticky-player .player-artist:hover {
  color: #fff;
  text-decoration: underline;
  cursor: pointer;
}

.sticky-player .player-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 120px;
}

/* Enhanced player controls styling */
.sticky-player .player-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  justify-content: center;
  max-width: 400px;
}

.sticky-player .control-btn {
  background: none;
  border: none;
  color: #b3b3b3;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sticky-player .control-btn:hover {
  color: #fff;
  transform: scale(1.05);
}

.sticky-player .control-btn.play-pause {
  background: #fff;
  color: #000;
  width: 32px;
  height: 32px;
}

.sticky-player .control-btn.play-pause:hover {
  background: #b3b3b3;
  transform: scale(1.06);
}

/* Enhanced range inputs */
.sticky-player input[type="range"] {
  height: 4px;
  background: #535353;
  outline: none;
  border: none;
  border-radius: 2px;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}

.sticky-player input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.sticky-player input[type="range"]:hover::-webkit-slider-thumb {
  opacity: 1;
}

.sticky-player input[type="range"]::-moz-range-thumb {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  border: none;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.sticky-player input[type="range"]:hover::-moz-range-thumb {
  opacity: 1;
}

/* Enhanced responsive design */
@media (max-width: 768px) {
  .sticky-player {
    min-height: 70px;
    max-height: 70px;
    padding: 0 12px;
    gap: 12px;
  }

  .sticky-player .player-cover {
    width: 48px;
    height: 48px;
  }

  .sticky-player .player-title {
    max-width: 140px;
    font-size: 13px;
  }

  .sticky-player .player-artist {
    max-width: 140px;
    font-size: 10px;
  }

  .sticky-player .player-main {
    flex: 0 0 35%;
  }
}

@media (max-width: 480px) {
  .sticky-player {
    min-height: 64px;
    max-height: 64px;
    padding: 0 8px;
    gap: 8px;
  }

  .sticky-player .player-cover {
    width: 40px;
    height: 40px;
  }

  .sticky-player .player-title {
    max-width: 100px;
    font-size: 12px;
  }

  .sticky-player .player-artist {
    max-width: 100px;
    font-size: 9px;
  }

  .sticky-player .control-btn.play-pause {
    width: 28px;
    height: 28px;
  }
}

/* --- Popup Backdrop --- */
.popup-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* --- Popup Player: Better Than Spotify --- */
.popup-player {
  position: relative;
  transform: none;
  background: linear-gradient(135deg, #232526 0%, #181818 100%);
  border-radius: 32px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  z-index: 3001;
  width: 420px;
  max-width: 98vw;
  padding: 2.5rem 2rem 2rem 2rem;
  animation: popupFadeIn 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
}
@keyframes popupFadeIn { from { opacity:0; transform:translate(-50%,-40%);} to { opacity:1; transform:translate(-50%,-50%);} }
.popup-header {
  font-weight: bold;
  color: gold !important;
  font-size: 1.3rem;
  margin-bottom: 1.2rem;
  letter-spacing: 1px;
}
.popup-cover {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
  margin-bottom: 1.5rem;
  border: none;
  background: transparent;
  overflow: visible;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.popup-cover .hz-circle {
  border-radius: 50%;
  transition: all 0.3s ease;
}

/* Circular Hertz Waveform Visualization */
.hertz-visualizer {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 140px;
  height: 140px;
  z-index: 1;
  pointer-events: none;
}

.hertz-visualizer canvas {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
}

@keyframes rotateCover {
  100% { transform: rotate(360deg); }
}

/* Enhanced bass pulse animation for 808s and kicks */
@keyframes bassPulse {
  0% {
    transform: scale(1);
    filter: brightness(1) saturate(1) drop-shadow(0 0 10px rgba(255, 215, 0, 0.4));
  }
  50% {
    transform: scale(1.3);
    filter: brightness(1.6) saturate(1.8) drop-shadow(0 0 25px rgba(255, 215, 0, 1)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.6));
  }
  100% {
    transform: scale(1);
    filter: brightness(1) saturate(1) drop-shadow(0 0 10px rgba(255, 215, 0, 0.4));
  }
}

.bass-pulse {
  animation: bassPulse 0.3s ease-out !important;
}

/* Combined rotation and pulse for bass hits */
.popup-cover.bass-pulse .hz-circle {
  animation: bassPulse 0.3s ease-out !important;
}

/* Direct SVG circle pulse */
.hz-circle.bass-pulse {
  animation: bassPulse 0.3s ease-out !important;
}

/* Maintain rotation during pulse */
.popup-cover.rotating .hz-circle {
  animation: rotateCover 8s linear infinite;
}

.popup-cover.rotating.bass-pulse .hz-circle {
  animation: rotateCover 8s linear infinite, bassPulse 0.3s ease-out;
}
.popup-meta {
  margin-bottom: 1.2rem;
  text-align: center;
}
.popup-controls {
  display: flex;
  align-items: center;
  gap: 2.2rem;
  margin-bottom: 1.2rem;
  justify-content: center;
}
.popup-btn {
  background: none;
  border: none;
  color: #1db954;
  font-size: 2.2rem;
  cursor: pointer;
  border-radius: 50%;
  transition: color 0.2s, box-shadow 0.2s;
  padding: 0.4rem;
}
.popup-btn:hover {
  color: #fff700;
  box-shadow: 0 0 12px #fff70088;
}
.popup-progress {
  width: 100%;
  margin-top: 1rem;
  margin-bottom: 1.2rem;
}
.popup-progress input[type="range"] {
  width: 100%;
  accent-color: #1db954;
  background: #181818;
  border-radius: 8px;
  height: 6px;
}
.popup-close {
  margin-top: 1rem;
  padding: 0.7rem 1.5rem;
  border: none;
  border-radius: 10px;
  background: #1db954;
  color: #181818;
  font-weight: bold;
  cursor: pointer;
  font-size: 1.05rem;
  box-shadow: 0 2px 8px #1db95455;
  transition: background 0.2s;
}
.popup-close:hover {
  color: #0066ff !important;
  background: #232526 !important;
}

/* Add to your CSS for fog overlay and popup enhancements */
#popupOverlay {
  transition: opacity 0.3s;
}
.popup-player {
  z-index: 3001;
}
.popup-btn.active {
  color: #fff700 !important;
  box-shadow: 0 0 12px #fff70088;
}
.popup-btn .popup-count {
  display: none;
}
.popup-btn.active .popup-count {
  display: inline;
}

/* Fix: Make the popup player queue button exactly the same size and style as other popup player buttons */
#queueBtnPopup {
  width: 2.2rem !important;
  height: 2.2rem !important;
  min-width: 2.2rem !important;
  min-height: 2.2rem !important;
  font-size: 2.2rem !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 0.4rem !important;
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  border-radius: 50% !important;
  color: #1db954 !important;
  transition: color 0.2s, box-shadow 0.2s;
}
#queueBtnPopup:hover {
  color: #fff700 !important;
  box-shadow: 0 0 12px #fff70088 !important;
}

/* Enhanced offline track display */
.offline-list {
  max-height: 500px;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding-right: 8px;
}

.offline-list::-webkit-scrollbar {
  width: 6px;
}

.offline-list::-webkit-scrollbar-track {
  background: #181818;
  border-radius: 3px;
}

.offline-list::-webkit-scrollbar-thumb {
  background: #1db954;
  border-radius: 3px;
}

.offline-list::-webkit-scrollbar-thumb:hover {
  background: #0066ff;
}

/* Enhanced track layout */
.offline-track {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.8rem;
  background: #181818;
  border-radius: 8px;
  padding: 0.8rem 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.2s;
  border: 1px solid transparent;
}

.offline-track:hover {
  background: #232526;
  border-color: #1db954;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Enhanced online results scrolling */
#onlineResults {
  max-height: 400px;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding-right: 8px;
}

/* Search suggestions styling (from playlist page) */
.search-suggestion {
  padding: 12px 16px;
  cursor: pointer;
  transition: background 0.2s;
  border-bottom: 1px solid #404040;
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-suggestion:last-child {
  border-bottom: none;
}

.search-suggestion:hover {
  background: #2a2a2a;
}

.search-suggestion.highlighted {
  background: #2196f3;
  color: #fff;
}

.suggestion-icon {
  width: 24px;
  height: 24px;
  background: linear-gradient(45deg, #2196f3, #4fc3f7);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #fff;
  flex-shrink: 0;
}

.suggestion-text {
  flex: 1;
  min-width: 0;
}

.suggestion-title {
  font-weight: 600;
  color: #fff;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.suggestion-artist {
  font-size: 12px;
  color: #b3b3b3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.search-suggestion.highlighted .suggestion-title,
.search-suggestion.highlighted .suggestion-artist {
  color: #fff;
}

#onlineResults::-webkit-scrollbar {
  width: 6px;
}

#onlineResults::-webkit-scrollbar-track {
  background: #181818;
  border-radius: 3px;
}

#onlineResults::-webkit-scrollbar-thumb {
  background: #1db954;
  border-radius: 3px;
}

#onlineResults::-webkit-scrollbar-thumb:hover {
  background: #0066ff;
}

/* --- Additions for Enhanced Player and Queue --- */
.player-btn.player-shuffle.active { color: #fff700 !important; box-shadow: 0 0 12px #fff70088; }
.player-btn.player-loop.active { color: #fff700 !important; box-shadow: 0 0 12px #fff70088; position:relative; }
.player-btn.player-loop.active #loopCount { display:inline; }
.queue-popup {
  position: fixed; bottom: 80px; right: 30px; width: 320px; background: #232526; border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.35); z-index: 2000; padding: 1rem;
}
.queue-header { font-weight: bold; color: #1db954; font-size: 1.1rem; margin-bottom: 1rem; }
.queue-list {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 220px;
  overflow-y: auto;
}
.queue-list li { background: #181818; color: #fff; margin-bottom: 0.5rem; padding: 0.7rem 1rem; border-radius: 8px; cursor: grab; display: flex; align-items: center; justify-content: space-between; }
.queue-list li.dragging { opacity: 0.5; }
.popup-player {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: linear-gradient(135deg, #232526 0%, #181818 100%);
  border-radius: 32px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  z-index: 3001;
  width: 400px;
  max-width: 98vw;
  padding: 2rem;
  animation: popupFadeIn 0.3s;
}
@keyframes popupFadeIn { from { opacity:0; transform:translate(-50%,-40%);} to { opacity:1; transform:translate(-50%,-50%);} }

/* Default rotation for popup cover when playing */
.popup-cover.rotating .hz-circle {
  animation: rotateCover 8s linear infinite;
}

@keyframes rotateCover { 100% { transform: rotate(360deg); } }
@keyframes equalizer {
  0%, 100% { height: 20px; }
  25% { height: 40px; }
  50% { height: 30px; }
  75% { height: 45px; }
}
.popup-header { font-weight: bold; color: #1db954; font-size: 1.1rem; margin-bottom: 1rem; }
.popup-meta { margin-top: 1rem; }

.main-nav {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: flex-start;
}
.main-nav .nav-btn {
  background: linear-gradient(45deg, #1db954, #1ed760);
  color: #fff;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 25px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
  text-decoration: none;
  display: inline-block;
  text-align: center;
}
.main-nav .nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
}
.main-nav .nav-btn.active {
  background: linear-gradient(45deg, #0066ff, #4d94ff);
  box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}
.main-nav .nav-btn.active:hover {
  box-shadow: 0 6px 20px rgba(0, 102, 255, 0.4);
}

/* Navigation Buttons (like liked page) */
.nav-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 2rem 0;
  flex-wrap: wrap;
}
.nav-buttons .nav-btn {
  background: linear-gradient(45deg, #1db954, #1ed760);
  color: #fff;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 25px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
  text-decoration: none;
  display: inline-block;
  text-align: center;
}
.nav-buttons .nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
}
.nav-buttons .nav-btn.active {
  background: linear-gradient(45deg, #0066ff, #4d94ff);
  box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}
.nav-buttons .nav-btn.active:hover {
  box-shadow: 0 6px 20px rgba(0, 102, 255, 0.4);
}

@media (max-width: 800px) {
  .main-nav {
    display: none !important;
  }
  .mobile-menu-btn {
    display: inline-block !important;
  }
  .nav-buttons {
    gap: 0.5rem;
    margin: 1.5rem 0;
  }
  .nav-buttons .nav-btn {
    padding: 0.6rem 1rem;
    font-size: 0.8rem;
  }
}
@media (min-width: 801px) {
  .mobile-menu-btn {
    display: none !important;
  }
  .mobile-nav {
    display: none !important;
  }
  .nav-buttons {
    display: none !important;
  }
}

/* Make the queue popup overlay the popup player and match its size/position */
.queue-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  width: 420px;
  max-width: 98vw;
  min-width: 260px;
  background: linear-gradient(135deg, #232526 0%, #181818 100%);
  border-radius: 32px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  z-index: 4000;
  padding: 2.5rem 2rem 2rem 2rem;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  animation: popupFadeIn 0.3s;
}
@media (max-width: 500px) {
  .queue-popup {
    width: 98vw;
    min-width: 0;
    padding: 1.2rem 0.5rem 1.2rem 0.5rem;
  }
}

/* Right-side search bar styling */
.search-bar-right input:focus {
  background: #333 !important;
  transform: scale(1.02);
}
.search-bar-right button:hover {
  background: #1ed760 !important;
}

@media (max-width: 768px) {
  .search-bar-right {
    position: fixed !important;
    top: 10px !important;
    right: 10px !important;
    padding: 0.6rem !important;
  }
  .search-bar-right input {
    min-width: 150px !important;
    font-size: 0.8rem !important;
  }
  .search-bar-right button {
    padding: 0.5rem 0.8rem !important;
    font-size: 0.8rem !important;
  }

  /* Queue popup mobile styles */
  #queuePopup {
    width: 100% !important;
    right: -100% !important;
  }
  #queuePopup.open {
    right: 0 !important;
  }
}

/* Drag and Drop Styles for Queue */
.queue-track {
  transition: all 0.2s ease, transform 0.1s ease !important;
}

.queue-track.dragging {
  opacity: 0.8;
  transform: scale(1.02);
  background: rgba(29, 185, 84, 0.2) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  border: 1px solid #1db954;
}

.queue-track.drag-over {
  border-top: 2px solid #1db954 !important;
  margin-top: 2px;
}

.drag-handle {
  cursor: grab;
  color: #666;
  opacity: 0;
  transition: opacity 0.2s, color 0.2s;
  padding: 4px;
  border-radius: 4px;
}

.queue-track:hover .drag-handle {
  opacity: 1;
  color: #b3b3b3;
}

.drag-handle:hover {
  color: #1db954 !important;
  background: rgba(255, 255, 255, 0.1);
}

.drag-handle:active {
  cursor: grabbing;
}

.queue-track[draggable="true"] {
  cursor: move;
}

.queue-placeholder {
  height: 2px;
  background: #1db954;
  margin: 4px 0;
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.2s;
}

.queue-placeholder.active {
  opacity: 1;
}

/* Change the cover image border and background, and all sticky/popup player button colors to #081AFF */
/* Cover image (popup and sticky) */
.popup-cover,
.sticky-player .player-cover {
  border: 4px solid #081AFF !important;
  background: #181818 !important;
}
.popup-cover span {
  color: #081AFF !important;
}

/* Player buttons (sticky and popup) */
.player-btn,
.popup-btn {
  color: #081AFF !important;
  border-color: #081AFF !important;
}
.player-btn:hover,
.popup-btn:hover,
.player-btn.active,
.popup-btn.active {
  color: #0066ff !important;
  box-shadow: 0 0 12px #0066ff88 !important;
  border-color: #0066ff !important;
}

/* Progress bar styling - Spotify-like */
.sticky-player input[type="range"],
.popup-player input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  height: 4px;
  background: #404040;
  border-radius: 2px;
  outline: none;
}

.sticky-player input[type="range"]::-webkit-slider-thumb,
.popup-player input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  height: 12px;
  width: 12px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  transition: all 0.2s;
}

.sticky-player input[type="range"]::-webkit-slider-thumb:hover,
.popup-player input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  background: #1ed760;
}

.sticky-player input[type="range"]::-moz-range-thumb,
.popup-player input[type="range"]::-moz-range-thumb {
  height: 12px;
  width: 12px;
  border-radius: 50%;
  background: #1db954;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

/* Enhanced range slider hover effects */
.sticky-player input[type="range"]:hover::-webkit-slider-thumb,
.popup-player input[type="range"]:hover::-webkit-slider-thumb {
  transform: scale(1.2);
  box-shadow: 0 0 0 8px rgba(29, 185, 84, 0.1);
}

.sticky-player input[type="range"]:hover,
.popup-player input[type="range"]:hover {
  background: #1db954 !important;
}

/* Player button hover effects - Spotify-like */
.player-btn:hover {
  color: #1db954 !important;
  transform: scale(1.05);
}

/* Like button specific hover - maintain red color when liked */
.player-btn.like-btn.liked:hover {
  color: #ff0000 !important;
}

.player-btn:active {
  transform: scale(0.95);
}

/* Queue button and popup controls - Spotify-like */
#queueBtnPopup,
.popup-close {
  color: #1db954 !important;
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  transition: all 0.2s;
}
#queueBtnPopup:hover,
.popup-close:hover {
  color: #1ed760 !important;
  background: rgba(29, 185, 84, 0.1) !important;
  border-radius: 8px !important;
}

/* Change the cover images for all tracks in the music library to #081AFF */
.offline-track img {
  border: 3px solid #081AFF !important;
  background: #181818 !important;
}

/* Make the queue button in the popup player gold */
#queueBtnPopup span > span {
  background: gold !important;
}
#queueBtnPopup {
  color: gold !important;
}
#queueBtnPopup:hover {
  color: #ffd700 !important;
}

/* Queue popup drag and drop styles */
.queue-track {
  transition: all 0.2s ease;
}

.queue-track.dragging {
  opacity: 0.5 !important;
  transform: scale(0.95);
}

.queue-track.drag-over {
  background: rgba(29, 185, 84, 0.2) !important;
  border-left: 3px solid #1db954;
}

.queue-placeholder {
  height: 2px !important;
  background: #1db954 !important;
  margin: 4px 0 !important;
  border-radius: 1px !important;
  transition: all 0.2s ease;
}

.queue-placeholder.active {
  height: 3px !important;
  background: #FFD700 !important;
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
}

.drag-handle {
  color: #666;
  cursor: grab;
  opacity: 0;
  transition: all 0.2s;
}

.queue-track:hover .drag-handle {
  opacity: 1;
  color: #1db954;
}

.drag-handle:active {
  cursor: grabbing;
}

/* Make mobile nav links blue (#081AFF) on hover and when active */
.mobile-nav .nav-btn {
  background: #232526;
  color: #fff;
  border: 2px solid transparent;
  transition: background 0.2s, color 0.2s, border-color 0.2s;
}
.mobile-nav .nav-btn:hover,
.mobile-nav .nav-btn.active,
.mobile-nav .nav-btn[aria-current="page"] {
  background: #081AFF !important;
  color: #fff !important;
  border-color: #081AFF !important;
}
  /* --- Track Menu Popup Styles --- */
  .track-menu-option:hover {
    background: #383a3b !important;
  }

  /* --- Video Menu Popup Styles --- */
  .video-menu-option:hover {
    background: #383a3b !important;
  }

  /* YouTube-style Video Player Styles - Mini Player by Default */
  .youtube-video-player {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 360px;
    height: auto;
    background: transparent;
    z-index: 5000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    pointer-events: none; /* Allow clicks to pass through the container */
    transition: transform 0.2s ease; /* Smooth dragging */
  }

  .youtube-video-player.dragging {
    transition: none; /* Disable transition while dragging */
    z-index: 5001;
  }

  .youtube-video-container {
    position: relative;
    width: 100%;
    height: auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #ff0000;
    box-shadow: 0 8px 32px rgba(255, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    pointer-events: auto; /* Enable clicks on the video itself */
  }

  .youtube-video-container:hover {
    transform: scale(1.02);
    box-shadow: 0 12px 40px rgba(255, 0, 0, 0.4);
  }

  .youtube-video-container.expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    z-index: 5001;
    cursor: default;
  }

  .youtube-video-container.expanded:hover {
    transform: translate(-50%, -50%);
  }

  .youtube-video-element {
    width: 100%;
    height: auto;
    display: block;
    background: #000;
  }

  .youtube-video-container:not(.expanded) .youtube-video-element {
    height: 202px;
    object-fit: cover;
  }

  .youtube-video-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    padding: 20px 15px 15px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .youtube-video-container:hover .youtube-video-controls,
  .youtube-video-controls.show {
    opacity: 1;
    visibility: visible;
  }

  .youtube-video-container:not(.expanded) .youtube-video-controls {
    display: none;
  }

  /* Mini Player Controls - Only show essential controls */
  .youtube-mini-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    font-size: 12px;
  }

  .youtube-video-container:not(.expanded):hover .youtube-mini-controls,
  .youtube-mini-controls.show {
    opacity: 1;
    visibility: visible;
  }

  .youtube-mini-controls-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .youtube-mini-controls-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .youtube-mini-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    font-size: 12px;
    transition: background 0.2s;
  }

  .youtube-mini-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .youtube-mini-time {
    color: white;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
  }

  .youtube-mini-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    cursor: pointer;
  }

  .youtube-mini-progress-bar {
    height: 100%;
    background: #ff0000;
    width: 0%;
    transition: width 0.1s ease;
  }

  /* Drag handle for mini player */
  .youtube-mini-drag-handle {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 30px;
    cursor: move;
    background: transparent;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .youtube-mini-drag-handle:hover {
    background: rgba(0, 0, 0, 0.3);
  }

  .youtube-mini-drag-handle:hover::after {
    content: "";
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
    letter-spacing: 2px;
  }

  .youtube-progress-container {
    position: relative;
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: height 0.2s ease;
  }

  .youtube-progress-container:hover {
    height: 8px;
  }

  .youtube-progress-bar {
    height: 100%;
    background: #ff0000;
    border-radius: 3px;
    position: relative;
    transition: all 0.2s ease;
  }

  .youtube-progress-handle {
    position: absolute;
    right: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    background: #ff0000;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s ease;
    cursor: pointer;
  }

  .youtube-progress-container:hover .youtube-progress-handle {
    opacity: 1;
  }

  .youtube-control-buttons {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .youtube-control-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .youtube-control-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .youtube-control-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
  }

  .youtube-control-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
  }

  .youtube-play-btn {
    font-size: 24px !important;
    min-width: 44px !important;
    height: 44px !important;
  }

  .youtube-time-display {
    color: white;
    font-size: 14px;
    font-family: 'Roboto Mono', monospace;
    font-weight: 500;
    margin: 0 8px;
    min-width: 80px;
    text-align: center;
  }

  .youtube-volume-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .youtube-volume-slider {
    width: 80px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
  }

  .youtube-volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
  }

  .youtube-volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }

  .youtube-title-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(rgba(0, 0, 0, 0.8), transparent);
    padding: 15px 20px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .youtube-video-container:hover .youtube-title-bar,
  .youtube-title-bar.show {
    opacity: 1;
    visibility: visible;
  }

  .youtube-video-container:not(.expanded) .youtube-title-bar {
    display: none;
  }

  .youtube-video-title {
    font-size: 18px;
    font-weight: 600;
    color: white;
    margin: 0;
  }

  .youtube-top-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .youtube-minimize-btn {
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .youtube-minimize-btn:hover {
    background: white;
    transform: scale(1.05);
  }

  .youtube-close-btn {
    background: #ff0000;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .youtube-close-btn:hover {
    background: #cc0000;
    transform: scale(1.05);
  }

  .youtube-fullscreen-btn {
    font-size: 20px !important;
  }

  /* Loading spinner for video */
  .youtube-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #ff0000;
    border-radius: 50%;
    animation: youtube-spin 1s linear infinite;
    z-index: 1000;
  }

  @keyframes youtube-spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .youtube-video-container {
      width: 95%;
    }

    .youtube-video-container.minimized {
      width: 280px;
      bottom: 100px;
      right: 10px;
    }

    .youtube-control-btn {
      font-size: 16px;
      padding: 6px;
      min-width: 32px;
      height: 32px;
    }

    .youtube-play-btn {
      font-size: 20px !important;
      min-width: 40px !important;
      height: 40px !important;
    }

    .youtube-volume-slider {
      width: 60px;
    }

    .youtube-time-display {
      font-size: 12px;
      min-width: 70px;
    }
  }
  </style>
</head>
<body>
  <!-- Hamburger Menu -->
  <button class="hamburger-menu" id="hamburgerMenu">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>

  <!-- Navigation Dropdown -->
  <div class="nav-dropdown" id="navDropdown">
    <a href="Hertz25App.html" class="nav-btn"> Home</a>
    <a href="Online25App.html" class="nav-btn"> Online</a>
    <a href="Offline25App.html" class="nav-btn active"> Offline</a>
    <a href="Playlist25App.html" class="nav-btn"> Playlists</a>
    <a href="Liked25App.html" class="nav-btn"> Liked</a>
    <a href="Account25App.html" class="nav-btn"> Account</a>
    <a href="Settings25App.html" class="nav-btn"> Settings</a>
  </div>

  <header>
    <h1 style="font-size:2.3rem;font-weight:900;color:#081AFF;letter-spacing:2px;margin:0;margin-left:80px;display:flex;align-items:center;gap:0.7rem;position:relative;">
      <span style="font-size:2.5rem;color:#081AFF;">&#127925;</span>
      <span style="color:gold;font-size:2.3rem;">HZ</span>
      <span style="font-size:1.3rem;color:#081AFF;font-weight:700;margin-left:0.5rem;">Offline Mode</span>
    </h1>
  </header>

  <!-- Enhanced Spotify-like Search Bar -->
  <div class="search-container" style="position:fixed;top:20px;right:20px;z-index:1500;display:flex;align-items:center;gap:0.5rem;">
    <!-- Search Toggle Button -->
    <button id="searchToggleBtn" class="search-toggle-btn" style="background:#232526;border:none;border-radius:50%;width:44px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.3);backdrop-filter:blur(10px);border:1px solid #404040;transition:all 0.3s ease;color:#b3b3b3;" title="Search">
      <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
      </svg>
    </button>

    <!-- Expandable Search Bar -->
    <div id="searchBarExpanded" class="search-bar-expanded" style="display:none;background:#232526;padding:0.4rem 0.6rem;border-radius:25px;box-shadow:0 4px 15px rgba(0,0,0,0.3);backdrop-filter:blur(10px);border:1px solid #404040;width:300px;position:relative;">
      <div style="display:flex;align-items:center;gap:0.6rem;">
        <svg width="16" height="16" fill="#b3b3b3" viewBox="0 0 16 16" style="flex-shrink:0;">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
        <input type="text" id="searchInput" placeholder="What do you want to listen to?" autocomplete="off" style="flex:1;border:none;background:transparent;color:#fff;font-size:0.9rem;outline:none;padding:0.2rem 0;">
        <button id="searchCloseBtn" style="background:none;border:none;color:#b3b3b3;cursor:pointer;padding:0.2rem;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;" title="Close">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
          </svg>
        </button>
      </div>

      <!-- Enhanced Search Suggestions Dropdown -->
      <div id="searchSuggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:#232526;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.4);border:1px solid #404040;max-height:400px;overflow-y:auto;margin-top:0.3rem;z-index:1600;">
        <!-- Suggestions will be populated here -->
      </div>
    </div>
  </div>

  <div class="spacer"></div>
  <div class="feature-container">
    <h2></h2>
    <p class="desc">For Producers to upload and play your own type beats and videos locally (offline).</p>

    <!-- Replace the file upload section with automatic processing -->
    <div style="display:flex;align-items:flex-start;gap:1.5rem;margin-bottom:2rem;">
      <!-- Automatic File Upload Section -->
      <div style="flex:1;">
        <h3 style="color:#1db954;margin-bottom:1rem;">Upload Files</h3>
        <div style="background:#181818;padding:1.5rem;border-radius:12px;border:2px dashed #1db954;text-align:center;margin-bottom:1rem;" id="dropZone">
          <p style="margin:0 0 1rem 0;color:#b3b3b3;">Drag and drop your music and video files here, or click to browse</p>
          <p style="margin:0;color:#1db954;font-size:0.9rem;">Files will be automatically added to your library</p>
          <!-- Make file input look like a button -->
          <label for="offlineFiles" style="display:inline-block;background:#1db954;color:#fff;border:none;padding:0.8rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;margin-top:1rem;text-align:center;">Browse Files</label>
          <input type="file" id="offlineFiles" multiple accept="audio/*,video/*,.mp3,.mp4,.webm,.avi,.mov,.wmv" style="display:none;">
        </div>

        <!-- Processing indicator removed for instant processing -->
      </div>
    </div>

    <!-- Enhanced two-column layout with full features -->
    <div style="display:flex;gap:1.5rem;margin-top:1.5rem;">
      <!-- Music Library Column -->
      <div style="flex:1;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <button id="selectAllBtn" style="background:#232526;color:#1db954;border:2px solid #1db954;padding:0.3rem 0.8rem;border-radius:6px;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.2s;">
              Select All
            </button>
            <button id="clearAllBtn" style="background:#d32f2f;color:#fff;padding:0.3rem 0.8rem;border:none;border-radius:6px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:background 0.2s;">
              Clear All Tracks
            </button>
          </div>
        </div>
        <h3 style="color:#1db954;margin-bottom:1rem;">Your Offline Music Library</h3>
        <!-- Enhanced container for music tracks -->
        <div style="background:#232526;border-radius:12px;border:2px solid #1db954;padding:1rem;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
            <span style="color:#1db954;font-weight:600;font-size:0.9rem;">Music Tracks</span>
            <span id="trackCount" style="color:#b3b3b3;font-size:0.8rem;">0 tracks</span>
          </div>
          <div class="offline-list" id="offlineLibrary" style="max-height:400px;overflow-y:auto;display:block;visibility:visible;background:#181818;border-radius:8px;padding:0.5rem;min-height:100px;">
            <!-- Music tracks will be rendered here -->
            <div id="emptyMusicMessage" style="text-align:center;color:#b3b3b3;padding:2rem;display:block;">
              No offline tracks yet. Upload some music files to get started!
            </div>
          </div>
        </div>
      </div>

      <!-- Video Library Column -->
      <div style="flex:1;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
          <button id="clearAllVideosBtn" style="background:#e91e63;color:#fff;padding:0.3rem 0.8rem;border:none;border-radius:6px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:background 0.2s;">
            Clear All Videos
          </button>
        </div>
        <h3 style="color:#ff6b6b;margin-bottom:1rem;">Your Offline Video Library</h3>
        <input type="text" id="videoSearchInput" placeholder="Search videos..." style="width:100%;padding:8px;margin-bottom:10px;border:1px solid #ff6b6b;border-radius:4px;background:#232526;color:#fff;font-size:0.9rem;">
        <!-- Enhanced container for video tracks -->
        <div style="background:#232526;border-radius:12px;border:2px solid #ff6b6b;padding:1rem;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
            <span style="color:#ff6b6b;font-weight:600;font-size:0.9rem;">Video Files</span>
            <span id="videoCount" style="color:#b3b3b3;font-size:0.8rem;">0 videos</span>
          </div>
          <div class="offline-video-list" id="offlineVideoLibrary" style="max-height:400px;overflow-y:auto;display:block;visibility:visible;background:#181818;border-radius:8px;padding:0.5rem;min-height:100px;">
            <!-- Video files will be rendered here -->
            <div id="emptyVideoMessage" style="text-align:center;color:#b3b3b3;padding:2rem;display:block;">
              No offline videos yet. Upload some video files to get started!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Sticky Player -->
  <div class="sticky-player" id="stickyPlayer" style="display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(90deg,#181818 0%,#282828 100%);border-top:1px solid #404040;padding:12px 16px;z-index:1000;cursor:grab;" draggable="false">
    <!-- Drag indicator -->
    <div class="drag-indicator"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;">
      <!-- Left section: Track info -->
      <div class="player-main" id="stickyPlayerMain" style="display:flex;align-items:center;gap:12px;cursor:pointer;flex:1;min-width:0;">
        <div id="playerCover" class="player-cover" style="width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:transparent;">
          <svg width="56" height="56" xmlns="http://www.w3.org/2000/svg" class="hz-circle">
            <defs>
              <radialGradient id="goldenSticky" cx="50%" cy="50%" r="50%">
                <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                <stop offset="30%" style="stop-color:#FFA500;stop-opacity:1" />
                <stop offset="70%" style="stop-color:#DA7F00;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#884D00;stop-opacity:1" />
              </radialGradient>
            </defs>
            <circle cx="28" cy="28" r="25" fill="url(#goldenSticky)" />
            <text x="28" y="34" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#000000">HZ</text>
          </svg>
        </div>
        <div class="player-meta" style="min-width:0;flex:1;">
          <div style="font-size:0.875rem;font-weight:400;color:#fff;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="playerTrackTitle">Track Name</div>
          <div style="font-size:0.75rem;color:#b3b3b3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="playerArtist">Artist Name</div>
        </div>
      </div>

      <!-- Center section: Player controls -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;flex:1;max-width:600px;">
        <!-- Control buttons -->
        <div style="display:flex;align-items:center;gap:16px;">
          <button class="player-btn" id="prevBtn" title="Previous" style="background:none;border:none;color:#b3b3b3;font-size:16px;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#b3b3b3'">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M6.271 5.055a.5.5 0 0 1 .52.026L11 7.055a.5.5 0 0 1 0 .89L6.791 9.919A.5.5 0 0 1 6 9.5V6.5a.5.5 0 0 1 .271-.445z"/></svg>
          </button>
          <button class="player-btn" id="playPauseBtn" title="Play/Pause" style="background:#fff;border:none;color:#000;font-size:16px;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
          </button>
          <button class="player-btn" id="nextBtn" title="Next" style="background:none;border:none;color:#b3b3b3;font-size:16px;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#b3b3b3'">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m9.729 5.055a.5.5 0 0 0-.52.026L5 7.055a.5.5 0 0 0 0 .89l4.209 1.973A.5.5 0 0 0 10 9.5V6.5a.5.5 0 0 0-.271-.445z"/></svg>
          </button>
        </div>

        <!-- Progress bar -->
        <div class="player-progress" style="display:flex;align-items:center;gap:8px;width:100%;">
          <span id="currentTime" style="font-size:0.75rem;color:gold;min-width:35px;text-align:right;font-weight:600;">0:00</span>
          <input type="range" id="progressBar" min="0" max="100" value="0" step="0.1" style="flex:1;height:4px;background:#404040;outline:none;border:none;border-radius:2px;-webkit-appearance:none;appearance:none;">
          <span id="duration" style="font-size:0.75rem;color:gold;min-width:35px;font-weight:600;">0:00</span>
        </div>
      </div>

      <!-- Right section: Volume control -->
      <div style="display:flex;align-items:center;gap:8px;flex:1;justify-content:flex-end;min-width:0;max-width:200px;">
        <div style="display:flex;align-items:center;gap:8px;width:100px;">
          <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.7" style="flex:1;height:4px;background:#404040;outline:none;border:none;border-radius:2px;-webkit-appearance:none;appearance:none;">
        </div>
      </div>
    </div>
    <audio id="playerAudio" class="player-audio"></audio>
  </div>

  <!-- Single Popup Player -->
  <div class="popup-backdrop" id="popupPlayer" style="display:none;">
    <div class="popup-player">
      <button onclick="closePopupPlayer()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:#b3b3b3;font-size:24px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.color='#fff';this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.color='#b3b3b3';this.style.background='none'" title="Close"></button>
      <button id="queueBtnPopup" class="popup-btn" aria-label="Queue" onclick="toggleQueue()" style="position:absolute;top:20px;left:20px;background:none;border:none;box-shadow:none;color:#1db954;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:8px;width:32px;height:32px;border-radius:50%;transition:all 0.2s;" onmouseover="this.style.background='rgba(29,185,84,0.1)'" onmouseout="this.style.background='none'" title="Queue">
        <span style="display:inline-block;line-height:1;">
          <span style="display:block;height:2px;width:16px;background:currentColor;border-radius:2px;margin:2px 0;"></span>
          <span style="display:block;height:2px;width:16px;background:currentColor;border-radius:2px;margin:2px 0;"></span>
          <span style="display:block;height:2px;width:16px;background:currentColor;border-radius:2px;margin:2px 0;"></span>
        </span>
      </button>

      <!-- Bass Detection Control Button -->
      <button onclick="toggleBassDetection()" id="bassDetectionBtn" style="position:absolute;top:60px;left:20px;background:#333;border:2px solid #666;color:#999;font-size:10px;cursor:pointer;padding:4px 8px;border-radius:4px;font-weight:bold;" title="Enable Bass Detection (Currently Disabled for Stability)">BASS OFF</button>

      <!-- Vertical volume control on the right side -->
      <div style="position:absolute;right:60px;top:60px;bottom:60px;display:flex;flex-direction:column;align-items:center;gap:10px;">
        <svg width="16" height="16" fill="gold" viewBox="0 0 16 16"><path d="M9 4a1 1 0 0 0-2 0v4a1 1 0 0 0 2 0V4zM6 6a1 1 0 0 1 2 0v2a1 1 0 1 1-2 0V6zM5 9a1 1 0 0 0 2 0V7a1 1 0 0 0-2 0v2zm8-3a1 1 0 0 0-2 0v4a1 1 0 0 0 2 0V6z"/></svg>
        <input type="range" id="popupVolumeRangeVertical" min="0" max="1" step="0.01" value="0.7" style="writing-mode:bt-lr;-webkit-appearance:slider-vertical;appearance:slider-vertical;width:6px;height:200px;background:gold;outline:none;border:none;border-radius:2px;">
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;">
        <!-- Rotating gold HZ circle with live Hertz visualization -->
        <div id="popupCover" class="popup-cover" style="margin-bottom:0.8rem;display:flex;align-items:center;justify-content:center;background:transparent;border:none;box-shadow:none;width:120px;height:120px;">
          <!-- Live Hertz Waveform Visualization -->
          <div class="hertz-visualizer">
            <canvas id="hertzCanvas" width="140" height="140"></canvas>
          </div>
          <!-- Center HZ Circle -->
          <svg width="120" height="120" xmlns="http://www.w3.org/2000/svg" class="hz-circle" style="z-index: 2; position: relative;">
            <defs>
              <radialGradient id="goldenPopup" cx="50%" cy="50%" r="50%">
                <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                <stop offset="30%" style="stop-color:#FFA500;stop-opacity:1" />
                <stop offset="70%" style="stop-color:#DA7F00;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#884D00;stop-opacity:1" />
              </radialGradient>
            </defs>
            <circle cx="60" cy="60" r="55" fill="url(#goldenPopup)" />
            <text x="60" y="75" font-family="Arial, sans-serif" font-size="42" font-weight="bold" text-anchor="middle" fill="#000000">HZ</text>
          </svg>
        </div>
        <!-- Track name and artist info -->
        <div class="player-meta" style="margin-bottom:0.8rem;text-align:center;max-width:300px;">
          <div style="font-size:1.1rem;font-weight:600;color:#fff;margin-bottom:0.3rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="popupTitle">Track Name</div>
          <div style="font-size:0.9rem;color:#b3b3b3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="popupArtist">Artist Name</div>
        </div>
        <!-- Progress bar with Spotify-like styling -->
        <div class="player-progress" style="display:flex;align-items:center;justify-content:center;gap:0.8rem;margin-bottom:1rem;width:100%;max-width:300px;">
          <span id="popupCurrentTime" style="font-size:0.85rem;color:gold;min-width:35px;font-weight:600;">0:00</span>
          <input type="range" id="popupProgressBar" min="0" max="100" value="0" step="0.1" style="flex:1;height:4px;background:#404040;outline:none;border:none;border-radius:2px;-webkit-appearance:none;appearance:none;">
          <span id="popupDuration" style="font-size:0.85rem;color:gold;min-width:35px;font-weight:600;">0:00</span>
        </div>
        <!-- Spotify-like control buttons -->
        <div class="player-controls" style="display:flex;align-items:center;gap:1.5rem;margin-bottom:1rem;">
          <button id="popupShuffleBtn" class="player-btn" style="background:none;border:none;color:#b3b3b3;font-size:1rem;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" title="Shuffle">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/><path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/></svg>
          </button>
          <button id="popupPrevBtn" class="player-btn" style="background:none;border:none;color:#b3b3b3;font-size:1.2rem;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" title="Previous">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m9.729 5.055a.5.5 0 0 0-.52.026L5 7.055a.5.5 0 0 0 0 .89l4.209 1.973A.5.5 0 0 0 10 9.5V6.5a.5.5 0 0 0-.271-.445z"/></svg>
          </button>
          <button class="player-btn" id="popupPlayPauseBtn" style="background:none;border:none;color:#b3b3b3;font-size:1.5rem;cursor:pointer;padding:12px;border-radius:50%;transition:all 0.2s;width:48px;height:48px;display:flex;align-items:center;justify-content:center;" title="Play/Pause">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
          </button>
          <button id="popupNextBtn" class="player-btn" style="background:none;border:none;color:#b3b3b3;font-size:1.2rem;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" title="Next">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M6.271 5.055a.5.5 0 0 1 .52.026L11 7.055a.5.5 0 0 1 0 .89L6.791 9.919A.5.5 0 0 1 6 9.5V6.5a.5.5 0 0 1 .271-.445z"/></svg>
          </button>
          <button id="popupLikeBtn" class="player-btn like-btn" style="background:none;border:none;color:#b3b3b3;font-size:1.2rem;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;position:relative;overflow:visible;" title="Like" onclick="togglePopupLike()">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.011L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/></svg>
          </button>
          <button id="popupLoopBtn" class="player-btn" style="background:none;border:none;color:#b3b3b3;font-size:1rem;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;" title="Repeat">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966A.25.25 0 0 1 11 5.466zm-6 4.534V11h6a4 4 0 0 0 3.584-5.777.5.5 0 1 1 .896-.446A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.3.3 0 0 1 0-.384l2.36-1.966A.25.25 0 0 1 5 10.534z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Popup (Spotify-style) -->
  <div id="queuePopup" class="queue-popup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;max-width:98vw;height:600px;max-height:90vh;background:linear-gradient(135deg, #232526 0%, #181818 100%);border-radius:32px;box-shadow:0 8px 32px rgba(0,0,0,0.45);z-index:3000;animation:popupFadeIn 0.3s;">
    <div class="queue-header" style="padding:1rem 2rem;border-bottom:1px solid #333;display:flex;align-items:center;justify-content:space-between;position:relative;">
      <h3 style="margin:0;color:#fff;font-size:1.1rem;font-weight:600;">Queue</h3>
      <button onclick="closeQueuePopup()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:#b3b3b3;font-size:24px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.color='#fff';this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.color='#b3b3b3';this.style.background='none'" title="Close"></button>
    </div>

    <div class="queue-content" style="height:calc(100% - 80px);overflow-y:auto;padding:0;">
      <!-- Now Playing Section -->
      <div class="queue-section" style="padding:1rem;border-bottom:1px solid #333;">
        <h4 style="margin:0 0 0.8rem 0;color:#1db954;font-size:0.9rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Now Playing</h4>
        <div id="queueNowPlaying" style="display:flex;align-items:center;gap:0.8rem;padding:0.5rem;border-radius:6px;background:rgba(29,185,84,0.1);">
          <div style="width:8px;height:40px;background:#1db954;border-radius:4px;animation:equalizer 1.5s ease-in-out infinite;"></div>
          <img id="queueCurrentCover" src="" alt="Cover" style="width:40px;height:40px;border-radius:4px;">
          <div style="flex:1;min-width:0;">
            <div id="queueCurrentTitle" style="color:#fff;font-size:0.9rem;font-weight:500;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
            <div id="queueCurrentArtist" style="color:#b3b3b3;font-size:0.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
          </div>
        </div>
      </div>

      <!-- Next Up Section -->
      <div class="queue-section" style="padding:1rem 1rem 0 1rem;">
        <h4 style="margin:0 0 0.8rem 0;color:#b3b3b3;font-size:0.9rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Next Up</h4>
        <div id="queueList" style="display:flex;flex-direction:column;gap:0.3rem;"></div>
      </div>

      <!-- Empty State -->
      <div id="queueEmpty" style="display:none;text-align:center;padding:2rem;color:#b3b3b3;">
        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" style="margin-bottom:1rem;opacity:0.5;">
          <path d="M9 4a1 1 0 0 0-2 0v4a1 1 0 0 0 2 0V4zM6 6a1 1 0 0 1 2 0v2a1 1 0 1 1-2 0V6zM5 9a1 1 0 0 0 2 0V7a1 1 0 0 0-2 0v2zm8-3a1 1 0 0 0-2 0v4a1 1 0 0 0 2 0V6z"/>
        </svg>
        <p style="margin:0;font-size:0.9rem;">Your queue is empty</p>
        <p style="margin:0.5rem 0 0 0;font-size:0.8rem;opacity:0.7;">Add tracks to see them here</p>
      </div>
    </div>
  </div>

  <!-- Queue backdrop -->
  <div id="queueBackdrop" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2999;" onclick="closeQueuePopup()"></div>

  <script>
  // Global variables
  let offlineTracks = [];
  let offlineVideos = [];
  let queue = [];
  let currentTrack = null;
  let currentIndex = 0;
  let isPlaying = false;
  let isSelectionMode = false;
  let selectedTracks = new Set();
  let dropZone, fileInput, selectAllBtn; // Removed processingIndicator, processingBar for instant processing

  // Load stored data on page load
  function loadStoredData(shouldRender = false) {
    console.log('=== LOADING STORED DATA ===');
    console.log('Should render:', shouldRender);

    // Load tracks from localStorage
    try {
      const storedTracks = localStorage.getItem('offlineTracks');
      if (storedTracks) {
        offlineTracks = JSON.parse(storedTracks);
        console.log('Loaded', offlineTracks.length, 'tracks from storage');
      }
    } catch (error) {
      console.error('Error loading tracks from storage:', error);
      offlineTracks = [];
    }

    // Load videos from localStorage
    try {
      const storedVideos = localStorage.getItem('offlineVideos');
      if (storedVideos) {
        offlineVideos = JSON.parse(storedVideos);
        console.log('Loaded', offlineVideos.length, 'videos from storage');
      }
    } catch (error) {
      console.error('Error loading videos from storage:', error);
      offlineVideos = [];
    }

    // Update queue with loaded tracks
    queue = [...offlineTracks];

    // Only render if DOM is ready
    if (shouldRender) {
      console.log('Rendering libraries after loading data');
      renderOfflineLibrary();
      renderOfflineVideoLibrary();
    }

    console.log('=== DATA LOADING COMPLETE ===');
  }

  // Enhanced save function to ensure data persistence
  function saveAllData() {
    try {
      // Check storage usage before saving
      const tracksData = JSON.stringify(offlineTracks);
      const videosData = JSON.stringify(offlineVideos);

      // Estimate storage usage (approximate)
      const estimatedSize = (tracksData.length + videosData.length) * 2; // UTF-16 encoding
      const maxSize = 5.3 * 1024 * 1024 * 1024; // 5.3GB limit for localStorage

      if (estimatedSize > maxSize) {
        console.warn('Data size exceeds localStorage limit. Consider removing some files.');
        // showNotification('Storage full. Consider removing some files.', 'warning'); // Removed notification per user request
        return;
      }

      localStorage.setItem('offlineTracks', tracksData);
      localStorage.setItem('offlineVideos', videosData);

      // Only log successful saves occasionally to reduce console spam
      const now = Date.now();
      if (!window.lastSaveLog || now - window.lastSaveLog > 60000) { // Log only once per minute
        console.log('All data saved to localStorage');
        window.lastSaveLog = now;
      }
    } catch (error) {
      if (error.name === 'QuotaExceededError') {
        console.error('Storage quota exceeded. Consider removing some files.');
        // showNotification('Storage full. Please remove some files to continue.', 'error'); // Removed notification per user request
      } else {
        console.error('Error saving data:', error);
      }
    }
  }

  // Auto-save data before page unload and clean up resources
  window.addEventListener('beforeunload', function() {
    // Clean up bass detection resources
    stopBassDetection();

    // Clean up audio context
    if (audioContext && audioContext.state !== 'closed') {
      audioContext.close().catch(console.error);
    }

    // Clear auto-save interval
    clearInterval(autoSaveInterval);

    // Save all data before leaving
    saveAllData();
  });

  // Auto-save data periodically (increased to 10 minutes for maximum stability)
  const autoSaveInterval = setInterval(saveAllData, 600000); // 10 minutes

  // Memory cleanup interval to prevent DevTools disconnection
  const memoryCleanupInterval = setInterval(() => {
    // Clean up any orphaned DOM elements
    if (window.gc) window.gc(); // Force garbage collection if available

    // Clear any accumulated timeouts
    bassTimeouts.forEach(timeout => clearTimeout(timeout));
    bassTimeouts.clear();

    // Only log occasionally
    if (!window.lastCleanupLog || Date.now() - window.lastCleanupLog > 600000) { // Every 10 minutes
      console.log(' Memory cleanup performed');
      window.lastCleanupLog = Date.now();
    }
  }, 120000); // Reduced to every 2 minutes for stability

  // Call loadStoredData immediately (just load data, don't render yet)
  loadStoredData(false);

  // Debug function to test file processing
  function debugFileProcessing() {
    console.log('=== DEBUG FILE PROCESSING ===');
    console.log('offlineTracks:', offlineTracks.length, offlineTracks);
    console.log('offlineVideos:', offlineVideos.length, offlineVideos);
    console.log('queue:', queue.length, queue);
    console.log('localStorage offlineTracks:', localStorage.getItem('offlineTracks'));
    console.log('localStorage offlineVideos:', localStorage.getItem('offlineVideos'));

    // Check if DOM elements exist
    console.log('offlineLibrary element:', document.getElementById('offlineLibrary'));
    console.log('offlineVideoLibrary element:', document.getElementById('offlineVideoLibrary'));

    // Force render
    console.log('Force rendering libraries...');
    renderOfflineLibrary();
    renderOfflineVideoLibrary();

    console.log('=== DEBUG COMPLETE ===');
  }  // Make debug function available globally
  window.debugFileProcessing = debugFileProcessing;

  // Test function to add a sample track
  function addTestTrack() {
    console.log('=== ADDING TEST TRACK ===');
    const testTrack = {
      id: 'test_' + Date.now(),
      name: 'Test Track',
      title: 'Test Track',
      artist: 'Test Artist',
      base64: 'data:audio/mp3;base64,test',
      audioUrl: 'data:audio/mp3;base64,test',
      thumbnail: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=",
      type: 'audio/mp3',
      size: 1000,
      uploadDate: Date.now(),
      dateAdded: Date.now(),
      liked: false,
      addedToLibrary: true
    };

    offlineTracks.push(testTrack);
    localStorage.setItem('offlineTracks', JSON.stringify(offlineTracks));
    queue = [...offlineTracks];

    console.log('Added test track, new length:', offlineTracks.length);
    renderOfflineLibrary();
    console.log('=== TEST TRACK ADDED ===');
  }

  window.addTestTrack = addTestTrack;

  // Function to check localStorage contents
  function checkLocalStorage() {
    console.log('=== CHECKING LOCALSTORAGE ===');
    console.log('localStorage keys:', Object.keys(localStorage));

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && (key.includes('Track') || key.includes('Video') || key.includes('offline'))) {
        console.log(`${key}:`, localStorage.getItem(key));
      }

    console.log('=== LOCALSTORAGE CHECK COMPLETE ===');
  }

  window.checkLocalStorage = checkLocalStorage;

    }
  // Bass Detection System for 808s and Kicks
  let audioContext = null;
  let analyser = null;
  let audioSource = null;
  let isAnalyserConnected = false;
  let bassDetectionEnabled = false; // Disabled by default for maximum stability
  let bassDetectionInitialized = false; // Add flag to prevent multiple initializations
  let bassDetectionFrame = null; // Track animation frame for proper cleanup
  let bassTimeouts = new Set(); // Track timeouts for cleanup

  // Initialize audio frequency analyzer
  function initBassDetection() {
    if (bassDetectionInitialized) return; // Prevent multiple initializations

    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 1024; // Higher resolution for better bass detection
      analyser.smoothingTimeConstant = 0.1; // Less smoothing for more responsive peaks
      analyser.minDecibels = -90;
      analyser.maxDecibels = -10;
      bassDetectionInitialized = true;
      console.log(' Bass detection system initialized with enhanced settings');
      console.log(' FFT Size:', analyser.fftSize, 'Frequency Bins:', analyser.frequencyBinCount);
    } catch (error) {
      console.log('Audio analysis not supported:', error);
      bassDetectionEnabled = false;
    }
  }

  // Connect audio element to analyzer
  function connectAudioToAnalyser() {
    if (!bassDetectionEnabled) {
      console.log(' Bass detection disabled');
      return;
    }

    const playerAudio = document.getElementById('playerAudio');
    if (!playerAudio) {
      console.log(' Player audio element not found');
      return;
    }

    if (!audioContext || !analyser) {
      console.log(' AudioContext or analyser not ready');
      initializeBassDetection();
      return;
    }

    if (isAnalyserConnected) {
      console.log(' Audio already connected to bass analyzer');
      return;
    }

    try {
      // Resume audio context if suspended
      if (audioContext.state === 'suspended') {
        console.log(' Resuming suspended audio context...');
        audioContext.resume().then(() => {
          console.log(' Audio context resumed');
        });
      }

      // Create audio source if not exists
      if (!audioSource) {
        console.log(' Creating audio source connection...');
        audioSource = audioContext.createMediaElementSource(playerAudio);
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);
        isAnalyserConnected = true;
        console.log(' Audio connected to bass analyzer');

        // Start a test pulse to verify it's working
        setTimeout(() => {
          console.log(' Testing bass pulse after connection...');
          triggerBassPulse();
        }, 1000);
      }
    } catch (error) {
      console.log(' Error connecting audio to analyzer:', error);
      // Try to reinitialize
      audioSource = null;
      isAnalyserConnected = false;
    }
  }

  // Enhanced frequency visualization with Hertz waveform display (heavily throttled for stability)
  let lastAnalysisTime = 0;
  const analysisThrottle = 500; // Increased to 500ms (2fps) for maximum stability
  let bassDetectionTimeout = null;
  let detectionCallCount = 0;
  let lastCallCountReset = Date.now();

  function detectBassAndPulse() {
    // Ultra-conservative safety mechanism: maximum 5 calls per second
    detectionCallCount++;
    const now = Date.now();
    if (now - lastCallCountReset > 1000) {
      if (detectionCallCount > 5) { // Reduced from 10 to 5 calls per second maximum
        console.warn('Bass detection exceeding safe limits, disabling for extended period');
        bassDetectionEnabled = false;
        setTimeout(() => {
          bassDetectionEnabled = true;
          console.log('Bass detection re-enabled after extended pause');
        }, 10000); // Extended pause to 10 seconds
        return;
      }
      detectionCallCount = 0;
      lastCallCountReset = now;
    }

    if (!bassDetectionEnabled || !analyser || !isAnalyserConnected) {
      // Only log this occasionally to prevent spam
      if (!window.lastNotReadyLog || now - window.lastNotReadyLog > 10000) {
        console.log('Audio analysis not ready:', {bassDetectionEnabled, analyser: !!analyser, isAnalyserConnected});
        window.lastNotReadyLog = now;
      }
      return;
    }

    if (now - lastAnalysisTime < analysisThrottle) {
      // Continue with highly throttled timing using setTimeout for maximum stability
      const playerAudio = document.getElementById('playerAudio');
      if (playerAudio && !playerAudio.paused) {
        bassDetectionTimeout = setTimeout(detectBassAndPulse, 500); // Consistent 500ms intervals
      } else {
        stopBassDetection();
      }
      return;
    }

    lastAnalysisTime = now;

    // Reuse the same buffer to prevent constant memory allocation
    if (!window.bassDataArray) {
      window.bassDataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    try {
      analyser.getByteFrequencyData(window.bassDataArray);
      // Update the circular Hertz visualization (throttled)
      updateHertzVisualization(window.bassDataArray);
    } catch (error) {
      // Silently handle any analysis errors to prevent crashes
      console.warn('Bass analysis error:', error.message);
    }

    // Continue analyzing if audio is playing - use setTimeout for better stability
    const playerAudio = document.getElementById('playerAudio');
    if (playerAudio && !playerAudio.paused) {
      bassDetectionTimeout = setTimeout(detectBassAndPulse, analysisThrottle);
    } else {
      // Clean up properly when stopping
      stopBassDetection();
    }
  }  // Circular Hertz Sine Wave Visualization
  let hertzCanvas = null;
  let hertzCtx = null;
  let rotationAngle = 0;

  function initHertzVisualization() {
    hertzCanvas = document.getElementById('hertzCanvas');
    if (!hertzCanvas) return;

    hertzCtx = hertzCanvas.getContext('2d');

    // Set up canvas for high DPI displays
    const rect = hertzCanvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    hertzCanvas.width = rect.width * dpr;
    hertzCanvas.height = rect.height * dpr;
    hertzCtx.scale(dpr, dpr);

    console.log(' Hertz visualization initialized');
  }

  let lastVisualizationUpdate = 0;
  const visualizationThrottle = 250; // Increased to 250ms for maximum stability

  function updateHertzVisualization(frequencyData) {
    if (!hertzCtx || !hertzCanvas) return;

    // Throttle visualization updates to reduce canvas operations
    const now = Date.now();
    if (now - lastVisualizationUpdate < visualizationThrottle) {
      return; // Skip this update
    }
    lastVisualizationUpdate = now;

    const centerX = hertzCanvas.width / 2 / (window.devicePixelRatio || 1);
    const centerY = hertzCanvas.height / 2 / (window.devicePixelRatio || 1);
    const baseRadius = 50;
    const maxRadius = 70;

    // Clear canvas more efficiently
    hertzCtx.clearRect(0, 0, hertzCanvas.width / (window.devicePixelRatio || 1), hertzCanvas.height / (window.devicePixelRatio || 1));

    // Create gradient for the waveform (cached)
    if (!hertzCtx.cachedGradient) {
      hertzCtx.cachedGradient = hertzCtx.createRadialGradient(centerX, centerY, baseRadius, centerX, centerY, maxRadius);
      hertzCtx.cachedGradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
      hertzCtx.cachedGradient.addColorStop(0.5, 'rgba(255, 165, 0, 0.6)');
      hertzCtx.cachedGradient.addColorStop(1, 'rgba(255, 215, 0, 0.2)');
    }

    hertzCtx.strokeStyle = hertzCtx.cachedGradient;
    hertzCtx.lineWidth = 2;
    hertzCtx.shadowColor = '#FFD700';
    hertzCtx.shadowBlur = 0; // Remove shadow for performance

    // Draw simplified circular waveform (reduced points for performance)
    hertzCtx.beginPath();

    const numPoints = Math.min(frequencyData.length, 32); // Further reduced to 32 points for maximum stability
    const angleStep = (Math.PI * 2) / numPoints;

    for (let i = 0; i < numPoints; i++) {
      const angle = i * angleStep + rotationAngle;

      // Get frequency data and normalize (skip some data points for performance)
      const dataIndex = Math.floor(i * (frequencyData.length / numPoints));
      const amplitude = frequencyData[dataIndex] || 0;
      const normalizedAmplitude = amplitude / 255;

      // Calculate radius based on frequency amplitude
      const radius = baseRadius + (normalizedAmplitude * (maxRadius - baseRadius));

      // Calculate position
      const x = centerX + Math.cos(angle) * radius;
      const y = centerY + Math.sin(angle) * radius;

      if (i === 0) {
        hertzCtx.moveTo(x, y);
      } else {
        hertzCtx.lineTo(x, y);
      }
    }

    hertzCtx.closePath();
    hertzCtx.stroke();

    // Add inner glow effect (simplified for performance)
    hertzCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    hertzCtx.lineWidth = 1;
    hertzCtx.shadowBlur = 0; // Remove shadow blur to reduce canvas operations
    hertzCtx.stroke();

    // Very slowly rotate the visualization to reduce updates
    rotationAngle += 0.005; // Reduced from 0.02 to 0.005 for less frequent updates
    if (rotationAngle > Math.PI * 2) {
      rotationAngle = 0;
    }
  }

  // Duplicate function removed - main detectBassAndPulse function defined above

  // Add cleanup function to prevent memory leaks
  function stopBassDetection() {
    // Clear animation frame if using requestAnimationFrame
    if (bassDetectionFrame) {
      cancelAnimationFrame(bassDetectionFrame);
      bassDetectionFrame = null;
    }

    // Clear timeout-based detection
    if (bassDetectionTimeout) {
      clearTimeout(bassDetectionTimeout);
      bassDetectionTimeout = null;
    }

    // Clear all pending timeouts
    bassTimeouts.forEach(timeout => clearTimeout(timeout));
    bassTimeouts.clear();

    // Reset history
    if (window.bassHistory) {
      window.bassHistory.fill(0);
      window.bassHistoryIndex = 0;
    }

    // Clear data array
    if (window.bassDataArray) {
      window.bassDataArray = null;
    }

    // Clear Hertz visualization canvas
    if (hertzCtx && hertzCanvas) {
      hertzCtx.clearRect(0, 0, hertzCanvas.width / (window.devicePixelRatio || 1), hertzCanvas.height / (window.devicePixelRatio || 1));
    }

    // Only log stop occasionally to prevent spam
    if (!window.lastAudioStopLog || Date.now() - window.lastAudioStopLog > 2000) {
      console.log(' Audio analysis stopped and cleaned up');
      window.lastAudioStopLog = Date.now();
    }
  }  // Global memory cleanup function
  function globalMemoryCleanup() {
    console.log(' Performing global memory cleanup');

    // Stop bass detection
    stopBassDetection();

    // Close audio context
    if (audioContext && audioContext.state !== 'closed') {
      audioContext.close().catch(console.error);
    }

    // Clear global variables
    window.bassHistory = null;
    window.bassDataArray = null;
    window.lastNotReadyLog = null;
    window.lastPulseLog = null;
    window.lastBassDetectLog = null;
    window.lastAudioStopLog = null;
    window.lastSaveLog = null;

    console.log(' Memory cleanup complete');
  }

  // Make cleanup function available globally
  window.globalMemoryCleanup = globalMemoryCleanup;

  // Handle page visibility changes with enhanced logging for monitoring
  document.addEventListener('visibilitychange', function() {
    const timestamp = new Date().toISOString();
    if (document.hidden) {
      // Tab is hidden, pause analysis to save resources
      stopBassDetection();
      console.log(` Bass detection paused (tab hidden) at ${timestamp}`);
    } else {
      // Tab is visible again, be very conservative about restarting
      const playerAudio = document.getElementById('playerAudio');
      if (playerAudio && !playerAudio.paused && bassDetectionEnabled) {
        setTimeout(() => {
          // Only restart if still enabled and safe
          if (bassDetectionEnabled && !document.hidden) {
            connectAudioToAnalyser();
            initializeHertzVisualization();
            // detectBassAndPulse(); // Disabled for maximum stability
            console.log(` Bass detection would resume (tab visible) at ${timestamp} - but disabled for stability`);
          }
        }, 500); // Increased delay for extra safety
      } else {
        console.log(` Tab visible but audio not playing or detection disabled at ${timestamp}`);
      }
    }
  });

  // Emergency safety: disable bass detection if ANY errors occur
  let devToolsDisconnectCount = 0;
  window.addEventListener('error', function(event) {
    devToolsDisconnectCount++;
    console.warn(`Error detected (${devToolsDisconnectCount}):`, event.message);
    if (devToolsDisconnectCount >= 1) { // Disable on FIRST error for maximum safety
      console.warn('Error detected, immediately disabling bass detection for absolute stability');
      bassDetectionEnabled = false;
      stopBassDetection();
      // Never re-enable automatically to guarantee stability
    }
  });

  // Additional DevTools connection monitor
  let performanceMonitorInterval = setInterval(() => {
    // Monitor performance and auto-disable if performance degrades
    if (performance.now() % 30000 < 1000) { // Check every ~30 seconds instead
      const memoryInfo = performance.memory;
      if (memoryInfo && memoryInfo.usedJSHeapSize > 1073741824) { // Increased to 1GB threshold to support larger storage
        console.warn('Memory usage approaching limit, maintaining safety mode');
        bassDetectionEnabled = false;
        stopBassDetection();
        clearInterval(performanceMonitorInterval);
      }
    }
  }, 120000); // Increased to check every 2 minutes

  // ULTIMATE PAGE KEEPALIVE - Ensures page never becomes inactive
  let keepAliveInterval = setInterval(() => {
    // Minimal, ultra-lightweight keepalive ping every 5 minutes
    // This prevents browser from considering the page inactive
    if (document.hidden) {
      // Even when hidden, maintain minimal activity
      console.log(' Page keepalive ping (hidden)');
    } else {
      // When visible, ultra-minimal activity
      const timestamp = Date.now();
      if (timestamp % 300000 < 5000) { // Log only once every 5 minutes
        console.log(' Page keepalive active');
      }
    }
  }, 300000); // Every 5 minutes - minimal frequency to avoid any performance impact

  // Initialize Hertz visualization when needed
  function initializeHertzVisualization() {
    if (!hertzCanvas) {
      initHertzVisualization();
    }
  }

  // Manual bass detection toggle for user control
  function toggleBassDetection() {
    const btn = document.getElementById('bassDetectionBtn');
    if (bassDetectionEnabled) {
      // Disable bass detection
      bassDetectionEnabled = false;
      stopBassDetection();
      btn.textContent = 'BASS OFF';
      btn.style.background = '#333';
      btn.style.color = '#999';
      btn.style.borderColor = '#666';
      btn.title = 'Enable Bass Detection (Currently Disabled for Stability)';
      console.log(' Bass detection manually disabled');
    } else {
      // Enable bass detection with user warning
      if (confirm(' CAUTION: Enabling bass detection may affect browser stability. Continue?')) {
        bassDetectionEnabled = true;
        btn.textContent = 'BASS ON';
        btn.style.background = 'gold';
        btn.style.color = '#000';
        btn.style.borderColor = 'gold';
        btn.title = 'Disable Bass Detection (Currently Active)';
        console.log(' Bass detection manually enabled - monitoring for stability');

        // Start bass detection if audio is playing
        const playerAudio = document.getElementById('playerAudio');
        if (playerAudio && !playerAudio.paused) {
          connectAudioToAnalyser();
          initializeHertzVisualization();
          detectBassAndPulse();
        }
      }
    }
  }

  // Legacy function for compatibility (no longer pulses, just logs)
  function triggerBassPulse() {
    // This function is now deprecated in favor of live Hertz visualization
    // Reduced frequency logging to prevent DevTools overload
    if (!window.lastPulseLog || Date.now() - window.lastPulseLog > 30000) { // Log only every 30 seconds
      console.log(' Hertz visualization available (manually enable with BASS button)');
      window.lastPulseLog = Date.now();
    }
  }

  // Test function for Hertz visualization (debugging) - now redirects to manual toggle
  function testBassPulse() {
    console.log(' Hertz visualization test - use BASS button to enable/disable');
    toggleBassDetection(); // Redirect to the manual control
  }

  // Initialize bass detection systems (disabled by default for stability)
  function initializeBassDetection() {
    if (bassDetectionInitialized) return; // Prevent multiple initializations

    if (!audioContext) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 1024; // Higher resolution for better bass detection
        analyser.smoothingTimeConstant = 0.1; // Less smoothing for more responsive peaks
        analyser.minDecibels = -90;
        analyser.maxDecibels = -10;
        bassDetectionEnabled = true;
        bassDetectionInitialized = true;
        console.log(' Bass detection system initialized - FFT Size:', analyser.fftSize, 'Bins:', analyser.frequencyBinCount);
      } catch (error) {
        console.log('Failed to initialize bass detection:', error);
      }
    }
  }  // Initialize bass detection when page loads (removed duplicate call)
  // initBassDetection(); // Removed - this was causing duplicate initialization

  // Additional safety - load and render when window is fully loaded
  window.addEventListener('load', function() {
    console.log('=== WINDOW FULLY LOADED ===');
    setTimeout(() => {
      console.log('Delayed render after window load');
      loadStoredData(true);
    }, 100);
  });

  // Wait for DOM to load before initializing
  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM LOADED - INITIALIZING FILE SYSTEM ===');

    // Load stored data and render libraries now that DOM is ready
    loadStoredData(true);

    // Initialize bass detection on first user interaction
    document.addEventListener('click', function initializeBassOnFirstClick() {
      initializeBassDetection();
      document.removeEventListener('click', initializeBassOnFirstClick);
    }, { once: true });

    // Get DOM elements after page loads
    dropZone = document.getElementById('dropZone');
    fileInput = document.getElementById('offlineFiles');
    selectAllBtn = document.getElementById('selectAllBtn');
    // Removed processingIndicator and processingBar for instant processing

    // File input handling
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        console.log('=== FILE INPUT CHANGED ===');
        console.log('File input changed, files:', e.target.files.length);
        console.log('offlineTracks before processing:', offlineTracks.length);
        console.log('offlineVideos before processing:', offlineVideos.length);

        if (e.target.files.length > 0) {
          // Removed processing notification for instant processing
          // showNotification(`Processing ${e.target.files.length} file${e.target.files.length > 1 ? 's' : ''}...`, 'info');

          for (let i = 0; i < e.target.files.length; i++) {
            console.log(`File ${i + 1}:`, e.target.files[i].name, e.target.files[i].type);
          }

          console.log('Calling processFilesAutomatically...');
          processFilesAutomatically(e.target.files);

          // Clear the file input to allow selecting the same files again if needed
          e.target.value = '';
        } else {
          console.log('No files selected');
        }
      });
      console.log(' File input event listener attached');
    } else {
      console.error(' File input not found');
    }

    // Click on drop zone triggers file input
    if (dropZone) {
      dropZone.addEventListener('click', function(e) {
        if (e.target.tagName.toLowerCase() !== 'label' && e.target.tagName.toLowerCase() !== 'input') {
          console.log('Drop zone clicked, triggering file input');
          fileInput?.click();
        }
      });
      console.log(' Drop zone click handler attached');
    } else {
      console.error(' Drop zone not found');
    }

    // Drag and drop handlers
    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#0066ff';
        dropZone.style.background = '#1a1a1a';
      });

      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#1db954';
        dropZone.style.background = '#181818';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#1db954';
        dropZone.style.background = '#181818';
        console.log('Files dropped:', e.dataTransfer.files.length);
        if (e.dataTransfer.files.length > 0) {
          processFilesAutomatically(e.dataTransfer.files);
        }
      });
      console.log(' Drag and drop handlers attached');
    }

    // Selection mode functionality
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        isSelectionMode = !isSelectionMode;
        if (isSelectionMode) {
          this.textContent = 'Cancel Selection';
          this.style.background = '#f44336';
          this.style.borderColor = '#f44336';
          this.style.color = '#fff';
        } else {
          this.textContent = 'Select All';
          this.style.background = '#232526';
          this.style.borderColor = '#1db954';
          this.style.color = '#1db954';
          selectedTracks.clear();
        }
        renderOfflineLibrary();
      });
      console.log(' Select all button handler attached');
    }

    // Popup player functionality
    const stickyPlayerMain = document.getElementById('stickyPlayerMain');
    const popupPlayer = document.getElementById('popupPlayer');

    if (stickyPlayerMain && popupPlayer) {
      // Click on sticky player (except buttons) to open popup
      stickyPlayerMain.addEventListener('click', function(e) {
        // Don't open popup if clicking on buttons
        if (e.target.closest('button') || e.target.closest('svg') || e.target.closest('input')) {
          return;
        }
        console.log('Opening popup player');
        openPopupPlayer();
      });

      // Close popup when clicking outside
      popupPlayer.addEventListener('click', function(e) {
        if (e.target === popupPlayer) {
          closePopupPlayer();
        }
      });

      // Drag functionality for sticky player
      let isDragging = false;
      let startY = 0;
      let currentY = 0;
      let dragThreshold = 50; // pixels to drag up to open popup

      const stickyPlayer = document.getElementById('stickyPlayer');

      // Mouse events
      stickyPlayer.addEventListener('mousedown', function(e) {
        // Don't drag if clicking on buttons or controls
        if (e.target.closest('button') || e.target.closest('svg') || e.target.closest('input')) {
          return;
        }

        isDragging = true;
        startY = e.clientY;
        stickyPlayer.style.cursor = 'grabbing';
        stickyPlayer.style.transition = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;

        currentY = e.clientY - startY;
        if (currentY < 0) { // Only allow upward drag
          stickyPlayer.classList.add('sticky-player-dragging');
          stickyPlayer.style.transform = `translateY(${Math.max(currentY, -100)}px)`;
        }
      });

      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;

        isDragging = false;
        stickyPlayer.style.cursor = 'grab';
        stickyPlayer.style.transition = '';
        stickyPlayer.classList.remove('sticky-player-dragging');
        stickyPlayer.style.transform = '';

        // Open popup if dragged up enough
        if (currentY < -dragThreshold) {
          openPopupPlayer();
        }

        currentY = 0;
      });

      // Touch events for mobile
      stickyPlayer.addEventListener('touchstart', function(e) {
        if (e.target.closest('button') || e.target.closest('svg') || e.target.closest('input')) {
          return;
        }

        isDragging = true;
        startY = e.touches[0].clientY;
        stickyPlayer.style.transition = 'none';
        e.preventDefault();
      });

      stickyPlayer.addEventListener('touchmove', function(e) {
        if (!isDragging) return;

        currentY = e.touches[0].clientY - startY;
        if (currentY < 0) {
          stickyPlayer.classList.add('sticky-player-dragging');
          stickyPlayer.style.transform = `translateY(${Math.max(currentY, -100)}px)`;
        }
        e.preventDefault();
      });

      stickyPlayer.addEventListener('touchend', function(e) {
        if (!isDragging) return;

        isDragging = false;
        stickyPlayer.style.transition = '';
        stickyPlayer.classList.remove('sticky-player-dragging');
        stickyPlayer.style.transform = '';

        if (currentY < -dragThreshold) {
          openPopupPlayer();
        }

        currentY = 0;
      });

      console.log(' Popup player handlers attached');
    }

    // Initialize libraries after DOM is ready
    initializeLibraries();

    // === POPUP PLAYER CONTROLS (moved from duplicate DOMContentLoaded) ===
    const popupPlayPauseBtn = document.getElementById('popupPlayPauseBtn');
    const popupProgressBar = document.getElementById('popupProgressBar');
    const popupVolumeRangeVertical = document.getElementById('popupVolumeRangeVertical');
    const playerAudio = document.getElementById('playerAudio');

    // Popup play/pause button
    if (popupPlayPauseBtn) {
      popupPlayPauseBtn.addEventListener('click', function() {
        togglePlayPause();
      });
    }

    // Sticky player buttons
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const loopBtn = document.getElementById('loopBtn');

    if (playPauseBtn) {
      playPauseBtn.addEventListener('click', togglePlayPause);
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', playPreviousTrack);
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', playNextTrack);
    }

    if (shuffleBtn) {
      shuffleBtn.addEventListener('click', toggleShuffle);
    }

    if (loopBtn) {
      loopBtn.addEventListener('click', toggleLoop);
    }

    // Popup player buttons
    const popupPrevBtn = document.getElementById('popupPrevBtn');
    const popupNextBtn = document.getElementById('popupNextBtn');
    const popupShuffleBtn = document.getElementById('popupShuffleBtn');
    const popupLoopBtn = document.getElementById('popupLoopBtn');

    if (popupPrevBtn) {
      popupPrevBtn.addEventListener('click', playPreviousTrack);
    }

    if (popupNextBtn) {
      popupNextBtn.addEventListener('click', playNextTrack);
    }

    if (popupShuffleBtn) {
      popupShuffleBtn.addEventListener('click', toggleShuffle);
    }

    if (popupLoopBtn) {
      popupLoopBtn.addEventListener('click', toggleLoop);
    }

    // Progress bar interactions
    const progressBar = document.getElementById('progressBar');
    if (progressBar && playerAudio) {
      progressBar.addEventListener('input', function() {
        if (playerAudio.duration) {
          const time = (this.value / 100) * playerAudio.duration;
          playerAudio.currentTime = time;
          updateTimeDisplay();

          // Sync popup progress bar
          const popupProgressBar = document.getElementById('popupProgressBar');
          if (popupProgressBar) {
            popupProgressBar.value = this.value;
          }
        }
      });
    }

    // Volume control interactions
    const volumeRange = document.getElementById('volumeRange');
    if (volumeRange && playerAudio) {
      volumeRange.addEventListener('input', function() {
        playerAudio.volume = this.value;

        // Sync popup volume
        const popupVolumeRangeVertical = document.getElementById('popupVolumeRangeVertical');
        if (popupVolumeRangeVertical) {
          popupVolumeRangeVertical.value = this.value;
        }
      });
    }

    // Popup progress bar sync
    if (popupProgressBar && playerAudio) {
      popupProgressBar.addEventListener('input', function() {
        const mainProgressBar = document.getElementById('progressBar');
        if (mainProgressBar) {
          mainProgressBar.value = this.value;
          const duration = playerAudio.duration;
          if (duration && !isNaN(duration)) {
            playerAudio.currentTime = (this.value / 100) * duration;
          }
        }
      });
    }

    // Popup volume control sync
    if (popupVolumeRangeVertical && playerAudio) {
      popupVolumeRangeVertical.addEventListener('input', function() {
        const mainVolumeRange = document.getElementById('volumeRange');
        if (mainVolumeRange) {
          mainVolumeRange.value = this.value;
          playerAudio.volume = this.value;
        }
      });
    }

    // Listen to audio events to update rotation animation
    if (playerAudio) {
      playerAudio.addEventListener('play', function() {
        isPlaying = true;
        const playerCover = document.getElementById('playerCover');
        const popupCover = document.querySelector('#popupCover img');

        if (playerCover) {
          playerCover.classList.add('rotating');
          playerCover.classList.remove('paused');
        }
        if (popupCover) {
          popupCover.classList.add('rotating');
          popupCover.classList.remove('paused');
        }
        updatePopupPlayButton();
      });

      playerAudio.addEventListener('pause', function() {
        isPlaying = false;
        const playerCover = document.getElementById('playerCover');
        const popupCover = document.querySelector('#popupCover img');

        if (playerCover) {
          playerCover.classList.add('paused');
        }
        if (popupCover) {
          popupCover.classList.add('paused');
        }
        updatePopupPlayButton();
      });

      // Update progress and time displays
      playerAudio.addEventListener('timeupdate', function() {
        updateTimeDisplay();
        updateProgressBar();

        const popupPlayer = document.getElementById('popupPlayer');
        if (popupPlayer && popupPlayer.style.display === 'flex') {
          syncPopupWithSticky();
        }
      });

      // Set duration when audio loads
      playerAudio.addEventListener('loadedmetadata', function() {
        updateDurationDisplay();
      });

      // Handle audio ending
      playerAudio.addEventListener('ended', function() {
        if (isLooped && currentTrack) {
          // Replay the current track
          playerAudio.currentTime = 0;
          playerAudio.play().catch(console.error);
        } else {
          playNextTrack();
        }
      });
    }

    console.log(' DOM initialization complete');
  });

  // Popup Player Functions
  function openPopupPlayer() {
    const popupPlayer = document.getElementById('popupPlayer');
    const popupCover = document.getElementById('popupCover'); // Target the container, not img
    const popupTitle = document.getElementById('popupTitle');
    const popupArtist = document.getElementById('popupArtist');
    const popupLikeBtn = document.getElementById('popupLikeBtn');

    if (popupPlayer && currentTrack) {
      // Initialize Hertz visualization when popup opens
      initializeHertzVisualization();

      // Update popup with current track info
      if (popupTitle) popupTitle.textContent = currentTrack.name;
      if (popupArtist) popupArtist.textContent = currentTrack.artist || 'Unknown Artist';

      // Update like button state
      if (popupLikeBtn) {
        if (currentTrack.liked) {
          popupLikeBtn.style.color = '#ff0000';
          popupLikeBtn.classList.add('liked');
        } else {
          popupLikeBtn.style.color = '#b3b3b3';
          popupLikeBtn.classList.remove('liked');
        }
      }

      if (popupCover) {
        // Add rotation animation to popup cover (SVG doesn't need src)
        if (!popupCover.classList.contains('rotating')) {
          popupCover.classList.add('rotating'); // Only add if not already rotating
          console.log(' Popup cover rotation started');
        }
        if (isPlaying) {
          popupCover.classList.remove('paused');
        } else {
          popupCover.classList.add('paused');
          console.log(' Popup cover rotation paused');
        }
      }

      popupPlayer.style.display = 'flex';
      syncPopupWithSticky();
    }
  }

  function closePopupPlayer() {
    const popupPlayer = document.getElementById('popupPlayer');
    const popupCover = document.getElementById('popupCover'); // Target the container, not img

    if (popupPlayer) {
      popupPlayer.style.display = 'none';
    }

    // Remove rotation from popup cover
    if (popupCover) {
      popupCover.classList.remove('rotating', 'paused');
    }
  }

  // Toggle like for popup player with glittering animation
  function togglePopupLike() {
    if (!currentTrack) return;

    const track = offlineTracks.find(t => t.id === currentTrack.id);
    if (!track) return;

    // Toggle like state
    track.liked = !track.liked;

    const likeBtn = document.getElementById('popupLikeBtn');
    if (likeBtn) {
      // Update button color immediately and add/remove liked class
      if (track.liked) {
        likeBtn.style.color = '#ff0000';
        likeBtn.classList.add('liked');
      } else {
        likeBtn.style.color = '#b3b3b3';
        likeBtn.classList.remove('liked');
      }

      // Add glittering animation
      likeBtn.classList.remove('like-btn-glitter');
      void likeBtn.offsetWidth; // Force reflow
      likeBtn.classList.add('like-btn-glitter');

      // Create sparkle particles if liked
      if (track.liked) {
        createSparkles(likeBtn);
      }

      // Remove animation class after animation completes and ensure color stays
      setTimeout(() => {
        likeBtn.classList.remove('like-btn-glitter');
        // Ensure the color stays red/gray after animation
        if (track.liked) {
          likeBtn.style.color = '#ff0000';
          likeBtn.classList.add('liked');
        } else {
          likeBtn.style.color = '#b3b3b3';
          likeBtn.classList.remove('liked');
        }
      }, 800);
    }

    // Save to database and update library after visual feedback
    saveTrackToDB(track);
    renderOfflineLibrary();

    // Also add to shared liked tracks for Liked25App.html
    try {
      let likedTracks = JSON.parse(localStorage.getItem('hertz_liked_tracks') || '[]');
      if (track.liked && !likedTracks.some(t => t.id === track.id)) {
        likedTracks.unshift({
          id: track.id,
          name: track.name,
          artist: track.artist,
          url: track.url || '',
          likedAt: new Date().toISOString()
        });
        localStorage.setItem('hertz_liked_tracks', JSON.stringify(likedTracks));
        localStorage.setItem('hertzLikedTracksUpdate', Date.now().toString());
      } else if (!track.liked) {
        // Remove from liked tracks if unliked
        likedTracks = likedTracks.filter(t => t.id !== track.id);
        localStorage.setItem('hertz_liked_tracks', JSON.stringify(likedTracks));
        localStorage.setItem('hertzLikedTracksUpdate', Date.now().toString());
      }
    } catch (e) {
      console.error('Error syncing liked track to global storage:', e);
    }
  }

  // Toggle like for sticky player
  function toggleStickyLike() {
    if (!currentTrack) return;

    const track = offlineTracks.find(t => t.id === currentTrack.id);
    if (!track) return;

    // Toggle like state
    track.liked = !track.liked;

    const stickyLikeBtn = document.getElementById('likeBtnSticky');
    const popupLikeBtn = document.getElementById('popupLikeBtn');

    // Update both button colors immediately
    if (stickyLikeBtn) {
      stickyLikeBtn.style.color = track.liked ? '#ff0000' : '#b3b3b3';
    }
    if (popupLikeBtn) {
      if (track.liked) {
        popupLikeBtn.style.color = '#ff0000';
        popupLikeBtn.classList.add('liked');
      } else {
        popupLikeBtn.style.color = '#b3b3b3';
        popupLikeBtn.classList.remove('liked');
      }
    }

    // Save to database and update library
    saveTrackToDB(track);
    renderOfflineLibrary();
  }

  // Create sparkle particles around the like button
  function createSparkles(button) {
    const rect = button.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    // Create 8 sparkles
    for (let i = 0; i < 8; i++) {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';

      // Random position around the button
      const angle = (i * 45) + Math.random() * 45; // 8 directions with randomness
      const distance = 20 + Math.random() * 20; // Random distance 20-40px
      const dx = Math.cos(angle * Math.PI / 180) * distance;
      const dy = Math.sin(angle * Math.PI / 180) * distance;

      sparkle.style.cssText = `
        position: fixed;
        left: ${centerX}px;
        top: ${centerY}px;
        width: ${2 + Math.random() * 3}px;
        height: ${2 + Math.random() * 3}px;
        background: ${Math.random() > 0.5 ? '#ff0000' : '#ffffff'};
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
        --dx: ${dx}px;
        --dy: ${dy}px;
      `;

      document.body.appendChild(sparkle);

      // Remove sparkle after animation
      setTimeout(() => {
        if (sparkle.parentNode) {
          sparkle.parentNode.removeChild(sparkle);
        }
      }, 1000);
    }
  }

  function syncPopupWithSticky() {
    const playerAudio = document.getElementById('playerAudio');
    const popupProgressBar = document.getElementById('popupProgressBar');
    const popupCurrentTime = document.getElementById('popupCurrentTime');
    const popupDuration = document.getElementById('popupDuration');
    const popupVolumeRangeVertical = document.getElementById('popupVolumeRangeVertical');
    const popupPlayPauseBtn = document.getElementById('popupPlayPauseBtn');

    if (playerAudio && popupProgressBar) {
      // Sync progress
      const progressBar = document.getElementById('progressBar');
      if (progressBar) {
        popupProgressBar.value = progressBar.value;
      }

      // Sync time displays
      const currentTime = document.getElementById('currentTime');
      const duration = document.getElementById('duration');
      if (currentTime && popupCurrentTime) {
        popupCurrentTime.textContent = currentTime.textContent;
      }
      if (duration && popupDuration) {
        popupDuration.textContent = duration.textContent;
      }

      // Sync volume
      const volumeRange = document.getElementById('volumeRange');
      if (volumeRange && popupVolumeRangeVertical) {
        popupVolumeRangeVertical.value = volumeRange.value;
      }

      // Sync play/pause button state
      updatePopupPlayButton();
    }
  }

  function updatePopupPlayButton() {
    const popupPlayPauseBtn = document.getElementById('popupPlayPauseBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');

    // Update both sticky and popup play/pause buttons
    [playPauseBtn, popupPlayPauseBtn].forEach(btn => {
      if (btn) {
        if (isPlaying) {
          // Show pause icon
          btn.innerHTML = btn === popupPlayPauseBtn ?
            '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5 6.25a.75.75 0 0 1 1.5 0V9.5a.75.75 0 0 1-1.5 0V6.25zm3.5 0a.75.75 0 0 1 1.5 0V9.5a.75.75 0 0 1-1.5 0V6.25z"/></svg>' :
            '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5 6.25a.75.75 0 0 1 1.5 0V9.5a.75.75 0 0 1-1.5 0V6.25zm3.5 0a.75.75 0 0 1 1.5 0V9.5a.75.75 0 0 1-1.5 0V6.25z"/></svg>';
        } else {
          // Show play icon
          btn.innerHTML = btn === popupPlayPauseBtn ?
            '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>' :
            '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>';
        }
      }
    });
  }

  // Time display functions
  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
  }

  function updateTimeDisplay() {
    const playerAudio = document.getElementById('playerAudio');
    const currentTime = document.getElementById('currentTime');
    const popupCurrentTime = document.getElementById('popupCurrentTime');

    if (playerAudio && currentTime) {
      const time = formatTime(playerAudio.currentTime);
      currentTime.textContent = time;
      if (popupCurrentTime) {
        popupCurrentTime.textContent = time;
      }
    }
  }

  function updateDurationDisplay() {
    const playerAudio = document.getElementById('playerAudio');
    const duration = document.getElementById('duration');
    const popupDuration = document.getElementById('popupDuration');

    if (playerAudio && duration) {
      const time = formatTime(playerAudio.duration);
      duration.textContent = time;
      if (popupDuration) {
        popupDuration.textContent = time;
      }
    }
  }

  function updateProgressBar() {
    const playerAudio = document.getElementById('playerAudio');
    const progressBar = document.getElementById('progressBar');
    const popupProgressBar = document.getElementById('popupProgressBar');

    if (playerAudio && progressBar && playerAudio.duration) {
      const progress = (playerAudio.currentTime / playerAudio.duration) * 100;
      progressBar.value = progress;
      if (popupProgressBar) {
        popupProgressBar.value = progress;
      }
    }
  }

  // Player control functions
  function playNextTrack() {
    if (queue.length === 0) return;

    currentIndex = (currentIndex + 1) % queue.length;
    const nextTrack = queue[currentIndex];
    if (nextTrack) {
      playTrack(nextTrack.id);
    }
  }

  function playPreviousTrack() {
    if (queue.length === 0) return;

    currentIndex = currentIndex <= 0 ? queue.length - 1 : currentIndex - 1;
    const prevTrack = queue[currentIndex];
    if (prevTrack) {
      playTrack(prevTrack.id);
    }
  }

  let isShuffled = false;
  let isLooped = false;
  let originalQueue = [];

  function toggleShuffle() {
    const shuffleBtn = document.getElementById('shuffleBtn');
    const popupShuffleBtn = document.getElementById('popupShuffleBtn');

    isShuffled = !isShuffled;

    if (isShuffled) {
      originalQueue = [...queue];
      // Fisher-Yates shuffle
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }
      currentIndex = queue.findIndex(t => t.id === currentTrack?.id);
    } else {
      queue = [...originalQueue];
      currentIndex = queue.findIndex(t => t.id === currentTrack?.id);
    }

    // Update button states with active indicator
    [shuffleBtn, popupShuffleBtn].forEach(btn => {
      if (btn) {
        if (isShuffled) {
          btn.style.color = '#1db954';
          btn.style.position = 'relative';
          // Add small "1" indicator
          btn.innerHTML = btn.innerHTML + '<span style="position:absolute;top:-2px;right:-2px;background:gold;color:#000;border-radius:50%;width:12px;height:12px;font-size:8px;display:flex;align-items:center;justify-content:center;font-weight:bold;">1</span>';
        } else {
          btn.style.color = '#b3b3b3';
          btn.style.position = '';
          // Remove indicator - restore original shuffle icon
          btn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/><path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/></svg>';
        }
      }
    });
  }

  function toggleLoop() {
    const loopBtn = document.getElementById('loopBtn');
    const popupLoopBtn = document.getElementById('popupLoopBtn');

    isLooped = !isLooped;

    // Update button states with active indicator
    [loopBtn, popupLoopBtn].forEach(btn => {
      if (btn) {
        if (isLooped) {
          btn.style.color = '#1db954';
          btn.style.position = 'relative';
          // Add small "1" indicator
          btn.innerHTML = btn.innerHTML + '<span style="position:absolute;top:-2px;right:-2px;background:gold;color:#000;border-radius:50%;width:12px;height:12px;font-size:8px;display:flex;align-items:center;justify-content:center;font-weight:bold;">1</span>';
        } else {
          btn.style.color = '#b3b3b3';
          btn.style.position = '';
          // Remove indicator - restore original loop icon
          btn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966A.25.25 0 0 1 11 5.466zm-6 4.534V11h6a4 4 0 0 0 3.584-5.777.5.5 0 1 1 .896-.446A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.3.3 0 0 1 0-.384l2.36-1.966A.25.25 0 0 1 5 10.534z"/></svg>';
        }
      }
    });
  }

  function togglePlayPause() {
    const playerAudio = document.getElementById('playerAudio');

    if (!playerAudio) return;

    if (isPlaying) {
      playerAudio.pause();
      isPlaying = false;
      // Clean up bass detection when pausing
      stopBassDetection();
    } else {
      playerAudio.play().then(() => {
        // Activate Hertz visualization when resuming playback
        connectAudioToAnalyser();
        initializeHertzVisualization();
        // detectBassAndPulse(); // Disabled for maximum stability
      }).catch(console.error);
      isPlaying = true;
    }

    // Update both sticky and popup play/pause buttons
    updatePopupPlayButton();
  }

  function toggleQueue() {
    const queuePopup = document.getElementById('queuePopup');
    const queueBackdrop = document.getElementById('queueBackdrop');

    if (!queuePopup) return;

    const isOpen = queuePopup.style.display === 'block';

    if (isOpen) {
      closeQueuePopup();
    } else {
      openQueuePopup();
    }
  }

  function openQueuePopup() {
    const queuePopup = document.getElementById('queuePopup');
    const queueBackdrop = document.getElementById('queueBackdrop');

    if (!queuePopup) return;

    // Show backdrop
    if (queueBackdrop) {
      queueBackdrop.style.display = 'block';
    }

    // Show and animate queue popup
    queuePopup.style.display = 'block';

    // Update queue content
    updateQueueDisplay();
  }

  function closeQueuePopup() {
    const queuePopup = document.getElementById('queuePopup');
    const queueBackdrop = document.getElementById('queueBackdrop');

    if (!queuePopup) return;

    // Hide backdrop
    if (queueBackdrop) {
      queueBackdrop.style.display = 'none';
    }

    // Hide queue popup
    queuePopup.style.display = 'none';
  }

  function updateQueueDisplay() {
    const queueNowPlaying = document.getElementById('queueNowPlaying');
    const queueCurrentCover = document.getElementById('queueCurrentCover');
    const queueCurrentTitle = document.getElementById('queueCurrentTitle');
    const queueCurrentArtist = document.getElementById('queueCurrentArtist');
    const queueList = document.getElementById('queueList');
    const queueEmpty = document.getElementById('queueEmpty');

    // Update now playing section
    if (currentTrack && queueCurrentTitle && queueCurrentArtist) {
      queueCurrentTitle.textContent = currentTrack.name || 'Unknown Track';
      queueCurrentArtist.textContent = currentTrack.artist || 'Unknown Artist';

      if (queueCurrentCover) {
        queueCurrentCover.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=';
      }

      if (queueNowPlaying) {
        queueNowPlaying.style.display = 'flex';
      }
    }

    // Get upcoming tracks (exclude current track)
    const upcomingTracks = queue.slice(currentIndex + 1);

    if (upcomingTracks.length === 0) {
      if (queueList) queueList.innerHTML = '';
      if (queueEmpty) queueEmpty.style.display = 'block';
      return;
    }

    if (queueEmpty) queueEmpty.style.display = 'none';

    // Build queue list HTML
    let queueHTML = '';
    upcomingTracks.forEach((track, index) => {
      const actualIndex = currentIndex + 1 + index;
      queueHTML += `
        <div class="queue-track"
             draggable="true"
             data-track-index="${actualIndex}"
             onclick="playQueueTrack(${actualIndex})"
             style="display:flex;align-items:center;gap:0.8rem;padding:0.5rem;border-radius:6px;cursor:pointer;transition:background 0.2s;"
             onmouseover="this.style.background='rgba(255,255,255,0.1)'"
             onmouseout="this.style.background='transparent'">

          <!-- Drag Handle -->
          <div class="drag-handle" title="Drag to reorder">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
              <circle cx="5" cy="3" r="1"/>
              <circle cx="11" cy="3" r="1"/>
              <circle cx="5" cy="8" r="1"/>
              <circle cx="11" cy="8" r="1"/>
              <circle cx="5" cy="13" r="1"/>
              <circle cx="11" cy="13" r="1"/>
            </svg>
          </div>

          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=" alt="Cover" style="width:40px;height:40px;border-radius:4px;">
          <div style="flex:1;min-width:0;">
            <div style="color:#fff;font-size:0.9rem;font-weight:500;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${track.name || 'Unknown Track'}</div>
            <div style="color:#b3b3b3;font-size:0.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${track.artist || 'Unknown Artist'}</div>
          </div>
          <button onclick="removeFromQueue(${actualIndex}); event.stopPropagation();" style="background:none;border:none;color:#b3b3b3;cursor:pointer;padding:4px;border-radius:50%;transition:all 0.2s;" onmouseover="this.style.color='#fff';this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.color='#b3b3b3';this.style.background='none'" title="Remove from queue">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
          </button>
        </div>
      `;
    });

    if (queueList) {
      queueList.innerHTML = queueHTML;

      // Add drag and drop event listeners
      initQueueDragAndDrop();
    }
  }

  function playQueueTrack(index) {
    if (index >= 0 && index < queue.length) {
      currentIndex = index;
      const track = queue[index];
      if (track) {
        playTrack(track.id);
        updateQueueDisplay();
        closeQueuePopup();
      }
    }
  }

  function removeFromQueue(index) {
    if (index > currentIndex && index < queue.length) {
      queue.splice(index, 1);
      updateQueueDisplay();
      showNotification('Removed from queue', 'success');
    }
  }

  // Drag and Drop Functions for Queue Reordering
  let draggedElement = null;
  let draggedIndex = null;
  let placeholder = null;

  function initQueueDragAndDrop() {
    const queueTracks = document.querySelectorAll('.queue-track[draggable="true"]');

    queueTracks.forEach((track, index) => {
      // Drag start
      track.addEventListener('dragstart', function(e) {
        draggedElement = this;
        draggedIndex = parseInt(this.dataset.trackIndex);
        this.classList.add('dragging');

        // Create and show placeholder
        placeholder = document.createElement('div');
        placeholder.className = 'queue-placeholder';
        placeholder.style.height = '2px';
        placeholder.style.background = '#1db954';
        placeholder.style.margin = '4px 0';
        placeholder.style.borderRadius = '1px';

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);

        // Hide original element after drag starts
        setTimeout(() => {
          if (draggedElement) {
            draggedElement.style.opacity = '0.5';
          }
        }, 0);
      });

      // Drag over
      track.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (this !== draggedElement) {
          const rect = this.getBoundingClientRect();
          const midPoint = rect.top + rect.height / 2;

          // Remove existing placeholder
          if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
          }

          // Add placeholder at appropriate position
          if (e.clientY < midPoint) {
            this.parentNode.insertBefore(placeholder, this);
          } else {
            this.parentNode.insertBefore(placeholder, this.nextSibling);
          }

          placeholder.classList.add('active');
        }
      });

      // Drag enter
      track.addEventListener('dragenter', function(e) {
        e.preventDefault();
        if (this !== draggedElement) {
          this.classList.add('drag-over');
        }
      });

      // Drag leave
      track.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      // Drop
      track.addEventListener('drop', function(e) {
        e.preventDefault();

        if (this !== draggedElement && draggedElement) {
          const draggedTrackIndex = draggedIndex;
          const targetTrackIndex = parseInt(this.dataset.trackIndex);

          // Calculate the new position in the queue
          const draggedQueueIndex = draggedTrackIndex;
          const targetQueueIndex = targetTrackIndex;

          // Only reorder if dropping on a different track
          if (draggedQueueIndex !== targetQueueIndex) {
            reorderQueue(draggedQueueIndex, targetQueueIndex);
          }
        }

        cleanup();
      });

      // Drag end
      track.addEventListener('dragend', function(e) {
        cleanup();
      });
    });

    // Cleanup function
    function cleanup() {
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement.style.opacity = '';
      }

      // Remove placeholder
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
      }

      // Remove drag-over class from all tracks
      document.querySelectorAll('.queue-track').forEach(track => {
        track.classList.remove('drag-over');
      });

      draggedElement = null;
      draggedIndex = null;
      placeholder = null;
    }
  }

  function reorderQueue(fromIndex, toIndex) {
    // Prevent reordering the currently playing track
    if (fromIndex <= currentIndex || toIndex <= currentIndex) {
      showNotification('Cannot reorder currently playing or past tracks', 'error');
      return;
    }

    // Move the track in the queue array
    const trackToMove = queue[fromIndex];
    queue.splice(fromIndex, 1);
    queue.splice(toIndex, 0, trackToMove);

    // Update the current index if necessary
    if (fromIndex < currentIndex && toIndex >= currentIndex) {
      currentIndex--;
    } else if (fromIndex > currentIndex && toIndex <= currentIndex) {
      currentIndex++;
    }

    // Update the display
    updateQueueDisplay();
    showNotification('Queue order updated', 'success');
  }

  // Make functions globally available
  window.toggleQueue = toggleQueue;
  window.closeQueuePopup = closeQueuePopup;
  window.playQueueTrack = playQueueTrack;
  window.removeFromQueue = removeFromQueue;
  window.initQueueDragAndDrop = initQueueDragAndDrop;
  window.reorderQueue = reorderQueue;

  // ESC key to close popup player
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const popupPlayer = document.getElementById('popupPlayer');
      if (popupPlayer && popupPlayer.style.display === 'flex') {
        closePopupPlayer();
      }
    }
  });

  // Instant file processing function - no delays or progress bars (reduced logging)
  function processFilesAutomatically(files) {
    if (files.length === 0) return;

    console.log('=== PROCESSING FILES INSTANTLY ===');
    console.log('Processing', files.length, 'files');

    let processed = 0;
    let audioCount = 0;
    let videoCount = 0;

    Array.from(files).forEach((file, index) => {
      const reader = new FileReader();

      reader.onload = function(e) {
        // Reduce console logging to prevent DevTools overload
        if (index === 0 || index === files.length - 1) {
          console.log('=== FILE READER ONLOAD TRIGGERED ===');
          console.log('File loaded successfully, size:', e.target.result.length);
        }
        const base64Data = e.target.result;
        const fileName = file.name.replace(/\.[^/.]+$/, '');
        const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        if (index === 0 || index === files.length - 1) {
          console.log('Generated file ID:', fileId);
          console.log('File name:', fileName);
          console.log('File type:', file.type);
        }

        // Check if it's an audio file (comprehensive detection for MP3s and other audio)
        if (file.type.startsWith('audio/') || /\.(mp3|wav|ogg|aac|flac|m4a|wma|opus|webm)$/i.test(file.name)) {
          // Create track object with proper structure
          const newTrack = {
            id: fileId,
            name: fileName,
            title: fileName, // Add title property for compatibility
            artist: 'Unknown Artist',
            base64: base64Data,
            audioUrl: base64Data, // Add audioUrl property for compatibility
            thumbnail: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=",
            type: file.type || 'audio/mp3',
            size: file.size,
            uploadDate: Date.now(),
            dateAdded: Date.now(),
            liked: false,
            addedToLibrary: true
          };

          // Add to tracks array
          console.log('About to add track to offlineTracks array');
          console.log('Current offlineTracks length:', offlineTracks.length);
          offlineTracks.push(newTrack);
          console.log('Added track! New offlineTracks length:', offlineTracks.length);
          console.log('New track added:', newTrack);

          // Update queue immediately
          queue = [...offlineTracks];
          audioCount++;

          // Save to storage immediately using enhanced save function
          saveAllData();
          saveTrackToDB(newTrack);

          // Instant UI update - no delays
          console.log('Instant UI update for track:', fileName);
          renderOfflineLibrary();

          // Update queue display if queue popup is open
          if (document.getElementById('queue-popup') && document.getElementById('queue-popup').style.display !== 'none') {
            updateQueueDisplay();
          }

          console.log('Added audio track:', fileName);
        }

        // Check if it's a video file (comprehensive detection)
        else if (file.type.startsWith('video/') || /\.(mp4|webm|avi|mov|wmv|m4v|mkv|flv|3gp|ogv)$/i.test(file.name)) {
          // Create video object
          const newVideo = {
            id: fileId,
            name: fileName,
            url: base64Data,
            type: file.type || 'video/mp4',
            size: file.size,
            uploadDate: Date.now(),
            dateAdded: Date.now(),
            addedToLibrary: true
          };

          // Add to videos array
          console.log('About to add video to offlineVideos array');
          console.log('Current offlineVideos length:', offlineVideos.length);
          offlineVideos.push(newVideo);
          console.log('Added video! New offlineVideos length:', offlineVideos.length);
          console.log('New video added:', newVideo);
          videoCount++;

          // Save to storage immediately using enhanced save function
          saveAllData();
          saveVideoToDB(newVideo);

          // Instant UI update for video
          renderOfflineVideoLibrary();

          console.log('Added video file:', fileName);
        }

        processed++;

        // When all files are processed - instant final update
        if (processed === files.length) {
          console.log('=== ALL FILES PROCESSED ===');
          console.log('Final offlineTracks length:', offlineTracks.length);
          console.log('Final offlineVideos length:', offlineVideos.length);
          console.log('Audio count:', audioCount, 'Video count:', videoCount);

          // Force update queue
          queue = [...offlineTracks];

          // Final instant render
          console.log('Final instant render - no delays');
          renderOfflineLibrary();
          renderOfflineVideoLibrary();

          console.log('=== LIBRARIES UPDATED INSTANTLY ===');

          // Log completion
          let message = '';
          if (audioCount > 0 && videoCount > 0) {
            message = `Added ${audioCount} audio track${audioCount > 1 ? 's' : ''} and ${videoCount} video${videoCount > 1 ? 's' : ''}!`;
          } else if (audioCount > 0) {
            message = `Added ${audioCount} audio track${audioCount > 1 ? 's' : ''}!`;
          } else if (videoCount > 0) {
            message = `Added ${videoCount} video${videoCount > 1 ? 's' : ''}!`;
          }

          console.log('File processing complete. Audio:', audioCount, 'Video:', videoCount);
        }
      };

      reader.onerror = function() {
        console.error('Error reading file:', file.name);
        processed++;
      };

      reader.readAsDataURL(file);
    });
  }

  // Functions defined outside DOMContentLoaded
function updateSelectAllButton() {
    if (isSelectionMode && selectAllBtn) {
      if (selectedTracks.size === offlineTracks.length && offlineTracks.length > 0) {
        selectAllBtn.textContent = 'Deselect All';
      } else if (selectedTracks.size === 0) {
        selectAllBtn.textContent = 'Select All';
      } else {
        selectAllBtn.textContent = `Selected ${selectedTracks.size}`;
      }
    }
  }

  // Menu functions
  window.toggleTrackMenu = function(trackId) {
    // Close all other menus
    document.querySelectorAll('.track-menu-popup').forEach(menu => {
      if (menu.id !== `menu-${trackId}`) menu.style.display = 'none';
    });

    const menu = document.getElementById(`menu-${trackId}`);
    if (menu) {
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
  };

  window.toggleVideoMenu = function(videoId, event) {
    event.stopPropagation();
    // Close all other menus
    document.querySelectorAll('.video-menu-popup').forEach(menu => {
      if (menu.id !== `video-menu-${videoId}`) menu.style.display = 'none';
    });

    const menu = document.getElementById(`video-menu-${videoId}`);
    if (menu) {
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
  };

  // Menu action functions
  window.likeTrack = function(trackId) {
    toggleLike(trackId);
    document.getElementById(`menu-${trackId}`).style.display = 'none';
  };

  window.addToQueue = function(trackId) {
    const track = offlineTracks.find(t => t.id === trackId);
    if (track && !queue.find(t => t.id === trackId)) {
      queue.push(track);
      showNotification('Added to queue!', 'success');
    }
    document.getElementById(`menu-${trackId}`).style.display = 'none';
  };

  // Place this inside your <script> tag, replacing ONLY the window.shareTrack function

  window.shareTrack = function(trackId, event) {
    if (event) event.stopPropagation();

    // Remove any existing dropdown
    document.getElementById('shareDropdown')?.remove();

    const track = offlineTracks.find(t => t.id === trackId);
    if (!track) return;

    // Social platforms and SVG icons (X replaces Twitter)
    const platforms = [
      {
        name: 'facebook',
        url: (link) => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`,
        icon: `<svg width="22" height="22" viewBox="0 0 32 32" fill="#1877f3"><path d="M29 0h-26c-1.7 0-3 1.3-3 3v26c0 1.7 1.3 3 3 3h13v-12h-4v-5h4v-4c0-4.1 2.5-6.3 6.1-6.3 1.8 0 3.6.3 3.6.3v4h-2c-2 0-2.6 1.2-2.6 2.5v3h5l-1 5h-4v12h7c1.7 0 3-1.3 3-3v-26c0-1.7-1.3-3-3-3z"/></svg>`
      },
      {
        name: 'x',
        url: (link, text) => `https://x.com/intent/tweet?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`,
        icon: `<svg width="22" height="22" viewBox="0 0 1200 1227" fill="#000"><path d="M1200 24.6L724.2 623.2 1196.6 1202.4h-273.2L600.2 823.2l-323.2 379.2H0l483.2-573.6L11.2 24.6h273.2l292.2 357.6L872.6 24.6zM900.8 1097.6h151.2L299.2 129.6H148z"/></svg>`
      },
      {
        name: 'instagram',
        url: (link) => `https://www.instagram.com/?url=${encodeURIComponent(link)}`,
        icon: `<svg width="22" height="22" viewBox="0 0 32 32" fill="#e1306c"><g><path d="M16 7.2a8.8 8.8 0 1 0 0 17.6 8.8 8.8 0 0 0 0-17.6zm0 14.4a5.6 5.6 0 1 1 0-11.2 5.6 5.6 0 0 1 0 11.2zm10.4-14.6a2.08 2.08 0 1 1-4.16 0 2.08 2.08 0 0 1 4.16 0zm5.92 2.12c-.13-2.62-.76-4.95-2.78-7.01C27.95.76 25.62.13 23 .01 20.37-.12 11.63-.12 9 .01 6.38.13 4.05.76 1.99 2.78.76 4.05.13 6.38.01 9c-.12 2.63-.12 11.37.01 14 .13 2.62.76 4.95 2.78 7.01C4.05 31.24 6.38 31.87 9 31.99c2.63.12 11.37.12 14-.01 2.62-.13 4.95-.76 7.01-2.78 2.02-2.06 2.65-4.39 2.78-7.01.12-2.63.12-11.37-.01-14zm-2.18 17.02a5.92 5.92 0 0 1-3.33 3.33c-2.3.91-7.76.7-10.91.7s-8.61.2-10.91-.7a5.92 5.92 0 0 1-3.33-3.33c-.91-2.3-.7-7.76-.7-10.91s-.2-8.61.7-10.91a5.92 5.92 0 0 1 3.33-3.33c2.3-.91 7.76-.7 10.91-.7s8.61-.2 10.91.7a5.92 5.92 0 0 1 3.33 3.33c.91 2.3.7 7.76.7 10.91s.2 8.61-.7 10.91z"/></g></svg>`
      },
      {
        name: 'whatsapp',
        url: (link, text) => `https://wa.me/?text=${encodeURIComponent(text + ' ' + link)}`,
        icon: `<svg width="22" height="22" viewBox="0 0 32 32" fill="#25d366"><g><path d="M16 3c-7.2 0-13 5.8-13 13 0 2.3.6 4.5 1.7 6.5l-2.2 6.5 6.7-2.2c1.9 1 4.1 1.6 6.5 1.6 7.2 0 13-5.8 13-13s-5.8-13-13-13zm0 23.7c-2.1 0-4.1-.5-5.9-1.5l-.4-.2-4 1.3 1.3-3.9-.2-.4c-1-1.7-1.6-3.7-1.6-5.9 0-6.1 5-11 11-11s11 5 11 11-5 11-11 11zm6.1-8.3c-.3-.2-1.7-.8-2-1-.3-.1-.5-.2-.7.2-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1-.3-.2-1.2-.4-2.3-1.3-.8-.7-1.3-1.5-1.5-1.8-.2-.3 0-.4.1-.6.1-.1.2-.3.3-.4.1-.1.1-.2.2-.3.1-.1.1-.2.2-.3.1-.1.1-.2.1-.3 0-.1 0-.2-.1-.3-.1-.1-.7-1.7-.9-2.3-.2-.6-.4-.5-.6-.5-.2 0-.3 0-.5 0-.2 0-.4.1-.6.3-.2.2-.8.8-.8 2 0 1.2.8 2.3 1.1 2.6.2.3 1.6 2.5 3.9 3.4.5.2.9.4 1.2.5.5.2.9.2 1.2.1.4-.1 1.3-.5 1.5-1 .2-.5.2-.9.1-1.1z"/></g></svg>`
      }
    ];

    // The link to share (could be a track page, or just the app)
    const shareLink = window.location.origin + window.location.pathname + `#track-${track.id}`;
    const shareText = `Check out "${track.name}" by ${track.artist || 'Unknown Artist'}`;

    // Find the menu button to position the dropdown
    const menuBtn = document.getElementById(`menu-${trackId}`);
    let dropdownParent = document.body;

    // Calculate position for dropdown
    let rect = menuBtn?.getBoundingClientRect();
    let top = rect ? rect.bottom + window.scrollY : 100;
    let left = rect ? rect.left + window.scrollX : 100;

    // Build dropdown HTML
    let dropdown = document.createElement('div');
    dropdown.id = 'shareDropdown';
    dropdown.style.position = 'absolute';
    dropdown.style.top = top + 'px';
    dropdown.style.left = left + 'px';
    dropdown.style.background = 'transparent'; // Remove grey background
    dropdown.style.borderRadius = '8px';
    dropdown.style.boxShadow = 'none'; // Remove shadow
    dropdown.style.padding = '0.3rem 0.5rem'; // Make very small
    dropdown.style.zIndex = 9999;
    dropdown.style.display = 'flex';
    dropdown.style.flexDirection = 'row'; // Horizontal row
    dropdown.style.gap = '0.3rem'; // Small gap
    dropdown.style.minWidth = 'unset';
    dropdown.style.width = 'auto';
    dropdown.style.height = 'auto';
    dropdown.style.alignItems = 'center';
    dropdown.style.justifyContent = 'center';

    platforms.forEach(platform => {
      let btn = document.createElement('a');
      btn.href = platform.url(shareLink, shareText);
      btn.target = '_blank';
      btn.rel = 'noopener noreferrer';
      btn.style.display = 'flex';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
      btn.style.background = 'none';
      btn.style.border = 'none';
      btn.style.color = '#fff';
      btn.style.fontWeight = '500';
      btn.style.fontSize = '1.2rem';
      btn.style.textDecoration = 'none';
      btn.style.padding = '0.5rem 0.2rem';
      btn.style.borderRadius = '6px';
      btn.style.transition = 'background 0.2s';
      btn.onmouseover = () => btn.style.background = '#181818';
      btn.onmouseout = () => btn.style.background = 'none';
      btn.innerHTML = `${platform.icon}`;
      dropdown.appendChild(btn);
    });

    // Remove dropdown on click outside
    setTimeout(() => {
      document.addEventListener('mousedown', function handler(e) {
        if (!dropdown.contains(e.target)) {
          dropdown.remove();
          document.removeEventListener('mousedown', handler);
        }
      });
    }, 10);

    // Insert dropdown in DOM
    dropdownParent.appendChild(dropdown);
  };

  window.shareVideo = function(videoId) {
    const video = offlineVideos.find(v => v.id === videoId);
    if (video) {
      navigator.clipboard.writeText(`Check out this video: ${video.name}`);
      showNotification('Video info copied to clipboard!', 'success');
    }
    document.getElementById(`video-menu-${videoId}`).style.display = 'none';
  };

  window.removeTrack = function(trackId) {
    if (confirm('Are you sure you want to remove this track from your library?')) {
      offlineTracks = offlineTracks.filter(t => t.id !== trackId);
      queue = queue.filter(t => t.id !== trackId);
      selectedTracks.delete(trackId);

      // Remove from database
      initDB().then(db => {
        const transaction = db.transaction(['tracks'], 'readwrite');
        const store = transaction.objectStore('tracks');
        store.delete(trackId);
      }).catch(() => {
        localStorage.removeItem('hertz_track_' + trackId);
      });

      renderOfflineLibrary();
      showNotification('Track removed from library', 'success');
    }
    document.getElementById(`menu-${trackId}`).style.display = 'none';
  };

  window.removeVideo = function(videoId) {
    if (confirm('Are you sure you want to remove this video from your library?')) {
      offlineVideos = offlineVideos.filter(v => v.id !== videoId);

      // Remove from database
      initDB().then(db => {
        const transaction = db.transaction(['videos'], 'readwrite');
        const store = transaction.objectStore('videos');
        store.delete(videoId);
      }).catch(() => {
        localStorage.removeItem('hertz_video_' + videoId);
      });

      renderOfflineVideoLibrary();
      showNotification('Video removed from library', 'success');
    }
    document.getElementById(`video-menu-${videoId}`).style.display = 'none';
  };

  // Close menus when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.track-menu') && !e.target.closest('.video-menu')) {
      document.querySelectorAll('.track-menu-popup, .video-menu-popup').forEach(menu => {
        menu.style.display = 'none';
      });
    }
  });

  // Enhanced play track function
  window.playTrack = function(trackId) {
    const track = offlineTracks.find(t => t.id === trackId);
    if (!track) return;

    currentTrack = track;

    // Ensure queue is set up properly
    if (queue.length === 0) {
      queue = [...offlineTracks];
    }

    currentIndex = queue.findIndex(t => t.id === trackId);
    if (currentIndex === -1) {
      // If track not in queue, add it and make it current
      queue.push(track);
      currentIndex = queue.length - 1;
    }

    const stickyPlayer = document.getElementById('stickyPlayer');
    const playerTitle = document.getElementById('playerTrackTitle');
    const playerArtist = document.getElementById('playerArtist');
    const playerAudio = document.getElementById('playerAudio');
    const playerCover = document.getElementById('playerCover');

    if (stickyPlayer && playerTitle && playerAudio) {
      stickyPlayer.style.display = 'flex';
      playerTitle.textContent = track.name;
      if (playerArtist) playerArtist.textContent = track.artist || 'Unknown Artist';

      playerAudio.src = track.base64;

      // Update duration when audio loads
      playerAudio.addEventListener('loadedmetadata', function() {
        updateDurationDisplay();
      }, { once: true });

      playerAudio.play().catch(console.error);
      isPlaying = true;

      // Start rotation animation on sticky player cover
      if (playerCover) {
        playerCover.classList.add('rotating');
        playerCover.classList.remove('paused');
      }

      // Update queue display if queue popup is open
      const queuePopup = document.getElementById('queuePopup');
      if (queuePopup && queuePopup.style.display === 'block') {
        updateQueueDisplay();
      }

      // If popup is open, update it too
      const popupPlayer = document.getElementById('popupPlayer');
      if (popupPlayer && popupPlayer.style.display === 'flex') {
        const popupCover = document.querySelector('#popupCover img');
        const popupTitle = document.getElementById('popupTitle');
        const popupArtist = document.getElementById('popupArtist');

        if (popupTitle) popupTitle.textContent = track.name;
        if (popupArtist) popupArtist.textContent = track.artist || 'Unknown Artist';
        if (popupCover) {
          popupCover.classList.add('rotating');
          popupCover.classList.remove('paused');
        }
        updatePopupPlayButton();
      }
    }
  };

  // Enhanced play video function - redirects to YouTube-style player
  window.playVideo = function(videoId) {
    playOfflineVideo(videoId);
  };

  // Enhanced toggle like function
  window.toggleLike = function(trackId) {
    const track = offlineTracks.find(t => t.id === trackId);
    if (track) {
      track.liked = !track.liked;
      saveTrackToDB(track);
      renderOfflineLibrary();

      const btn = document.querySelector(`button[onclick="toggleLike('${trackId}')"]`);
      if (btn) {
        btn.style.color = track.liked ? '#fff700' : '#ff4081';
        btn.classList.add('like-btn-pop');
        setTimeout(() => btn.classList.remove('like-btn-pop'), 350);
      }

      showNotification(track.liked ? 'Added to liked!' : 'Removed from liked!', 'success');
    }
  };

  // Clear all functions with proper confirmation
  document.getElementById('clearAllBtn')?.addEventListener('click', async function() {
    if (confirm('Are you sure you want to delete all music tracks? This action cannot be undone.')) {
      offlineTracks = [];
      queue = [];
      selectedTracks.clear();

      try {
        const db = await initDB();
        const transaction = db.transaction(['tracks'], 'readwrite');
        const store = transaction.objectStore('tracks');
        store.clear();
      } catch (error) {
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const key = localStorage.key(i);
          if (key && key.startsWith('hertz_track_')) {
            localStorage.removeItem(key);
          }
        }
      }

      renderOfflineLibrary();
      showNotification('All music tracks cleared!', 'success');
    }
  });

  document.getElementById('clearAllVideosBtn')?.addEventListener('click', async function() {
    if (confirm('Are you sure you want to delete all videos? This action cannot be undone.')) {
      offlineVideos = [];

      try {
        const db = await initDB();
        const transaction = db.transaction(['videos'], 'readwrite');
        const store = transaction.objectStore('videos');
        store.clear();
      } catch (error) {
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const key = localStorage.key(i);
          if (key && key.startsWith('hertz_video_')) {
            localStorage.removeItem(key);
          }
        }
      }

      renderOfflineVideoLibrary();
      showNotification('All videos cleared!', 'success');
    }
  });

  // Enhanced Spotify-like search functionality
  const searchInput = document.getElementById('searchInput');
  const searchSuggestions = document.getElementById('searchSuggestions');
  const searchToggleBtn = document.getElementById('searchToggleBtn');
  const searchBarExpanded = document.getElementById('searchBarExpanded');
  const searchCloseBtn = document.getElementById('searchCloseBtn');

  // Search toggle functionality
  function toggleSearchBar() {
    const isVisible = searchBarExpanded.style.display !== 'none';

    if (!isVisible) {
      searchBarExpanded.style.display = 'block';
      searchToggleBtn.style.background = '#1db954';
      searchToggleBtn.style.color = '#fff';
      // Animate the search bar appearance
      searchBarExpanded.style.opacity = '0';
      searchBarExpanded.style.transform = 'translateX(20px)';
      setTimeout(() => {
        searchBarExpanded.style.transition = 'all 0.3s ease';
        searchBarExpanded.style.opacity = '1';
        searchBarExpanded.style.transform = 'translateX(0)';
      }, 10);
      // Focus the input
      setTimeout(() => searchInput.focus(), 100);
    } else {
      searchBarExpanded.style.opacity = '0';
      searchBarExpanded.style.transform = 'translateX(20px)';
      setTimeout(() => {
        searchBarExpanded.style.display = 'none';
        searchToggleBtn.style.background = '#232526';
        searchToggleBtn.style.color = '#b3b3b3';
      }, 300);
      hideSuggestions();
      searchInput.value = '';
      renderOfflineLibrary(); // Reset the display
    }
  }

  // Event listeners for search toggle
  searchToggleBtn?.addEventListener('click', toggleSearchBar);
  searchCloseBtn?.addEventListener('click', toggleSearchBar);

  // Search toggle button hover effects
  searchToggleBtn?.addEventListener('mouseenter', function() {
    if (searchBarExpanded.style.display === 'none') {
      this.style.background = '#333';
      this.style.color = '#1db954';
    }
  });

  searchToggleBtn?.addEventListener('mouseleave', function() {
    if (searchBarExpanded.style.display === 'none') {
      this.style.background = '#232526';
      this.style.color = '#b3b3b3';
    }
  });

  function performSearch() {
    const query = searchInput?.value?.toLowerCase() || '';
    if (!query) {
      renderOfflineLibrary();
      hideSuggestions();
      return;
    }

    const filteredTracks = offlineTracks.filter(track =>
      track.name.toLowerCase().includes(query) ||
      (track.artist && track.artist.toLowerCase().includes(query))
    );

    // Temporarily modify the tracks array for rendering
    const originalTracks = offlineTracks;
    offlineTracks = filteredTracks;
    renderOfflineLibrary();
    offlineTracks = originalTracks;
    hideSuggestions();
  }

  function showSuggestions(query) {
    if (!query || query.length < 2) {
      hideSuggestions();
      return;
    }

    const matchingTracks = offlineTracks.filter(track =>
      track.name.toLowerCase().includes(query.toLowerCase()) ||
      (track.artist && track.artist.toLowerCase().includes(query.toLowerCase()))
    ).slice(0, 8); // Show more suggestions like Spotify

    if (matchingTracks.length === 0) {
      hideSuggestions();
      return;
    }

    let suggestionsHTML = '';
    matchingTracks.forEach((track, index) => {
      const artist = track.artist || 'Unknown Artist';
      const isLast = index === matchingTracks.length - 1;
      suggestionsHTML += `
        <div class="search-suggestion" data-track-id="${track.id}" style="padding:0.8rem 1rem;cursor:pointer;${!isLast ? 'border-bottom:1px solid #404040;' : ''}display:flex;align-items:center;gap:0.8rem;transition:all 0.2s ease;">
          <div style="width:40px;height:40px;background:linear-gradient(45deg, #FFD700, #FFA500);border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <svg width="20" height="20" fill="#000" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M6.271 5.055a.5.5 0 0 1 .52.026L11 7.055a.5.5 0 0 1 0 .89L6.791 9.919A.5.5 0 0 1 6 9.5V6.5a.5.5 0 0 1 .271-.445z"/>
            </svg>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="color:#fff;font-weight:500;font-size:0.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${track.name}</div>
            <div style="color:#b3b3b3;font-size:0.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Song  ${artist}</div>
          </div>
          <div style="color:#b3b3b3;font-size:0.7rem;opacity:0;transition:opacity 0.2s;flex-shrink:0;font-weight:500;">PLAY</div>
        </div>
      `;
    });

    searchSuggestions.innerHTML = suggestionsHTML;
    searchSuggestions.style.display = 'block';

    // Add click listeners to suggestions
    document.querySelectorAll('.search-suggestion').forEach(suggestion => {
      suggestion.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255, 255, 255, 0.1)';
        this.querySelector('div:last-child').style.opacity = '1';
      });
      suggestion.addEventListener('mouseleave', function() {
        this.style.background = 'transparent';
        this.querySelector('div:last-child').style.opacity = '0';
      });
      suggestion.addEventListener('click', function() {
        const trackId = this.dataset.trackId;
        playTrack(trackId);
        searchInput.value = '';
        hideSuggestions();
        toggleSearchBar(); // Close search bar after playing
        // showNotification(' Now playing', 'success'); // Removed notification
      });
    });
  }

  function hideSuggestions() {
    if (searchSuggestions) {
      searchSuggestions.style.display = 'none';
    }
  }

  // Enhanced input event listener for real-time suggestions
  searchInput?.addEventListener('input', function() {
    const query = this.value.trim();
    showSuggestions(query);
  });

  // Hide suggestions when clicking outside
  document.addEventListener('click', function(e) {
    const searchContainer = document.querySelector('.search-container');
    if (!searchContainer?.contains(e.target)) {
      hideSuggestions();
    }
  });

  // Enhanced focus and blur events
  searchInput?.addEventListener('focus', function() {
    const query = this.value.trim();
    if (query.length >= 2) {
      showSuggestions(query);
    }
  });

  // Handle Enter key press
  searchInput?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      performSearch();
      hideSuggestions();
    }
  });

  // Escape key to close search
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && searchBarExpanded.style.display !== 'none') {
      toggleSearchBar();
    }
  });

  // Video search
  const videoSearchInput = document.getElementById('videoSearchInput');
  videoSearchInput?.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    if (!query) {
      renderOfflineVideoLibrary();
      return;
    }

    const filteredVideos = offlineVideos.filter(video =>
      video.name.toLowerCase().includes(query)
    );

    const originalVideos = offlineVideos;
    offlineVideos = filteredVideos;
    renderOfflineVideoLibrary();
    offlineVideos = originalVideos;
  });

  // Enhanced notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');

    // Special gold styling for "Now playing" messages
    const isNowPlaying = message.includes('Now playing:');

    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; padding: 15px 20px;
      background: ${isNowPlaying ? 'linear-gradient(135deg, #FFD700, #FFA500)' : type === 'success' ? '#1db954' : type === 'error' ? '#f44336' : '#2196F3'};
      color: ${isNowPlaying ? '#000' : 'white'}; border-radius: 8px; z-index: 10000; font-size: 14px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transform: translateX(100%);
      transition: all 0.3s ease; max-width: 400px; word-wrap: break-word;
      ${isNowPlaying ? 'border: 2px solid #B8860B;' : ''}
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }

  window.showNotification = showNotification;

  // Hamburger menu functionality
  const hamburgerMenu = document.getElementById('hamburgerMenu');
  const navDropdown = document.getElementById('navDropdown');

  if (hamburgerMenu && navDropdown) {
    hamburgerMenu.addEventListener('click', function() {
      hamburgerMenu.classList.toggle('active');
      navDropdown.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!hamburgerMenu.contains(e.target) && !navDropdown.contains(e.target)) {
        hamburgerMenu.classList.remove('active');
        navDropdown.classList.remove('show');
      }
    });
  }

  // Initialize libraries on page load
  async function initializeLibraries() {
    console.log('=== INITIALIZING OFFLINE LIBRARIES ===');
    console.log('Current offlineTracks before loading from DB:', offlineTracks.length);
    console.log('Current offlineVideos before loading from DB:', offlineVideos.length);
    try {
      const dbTracks = await loadTracksFromDB();
      const dbVideos = await loadVideosFromDB();

      // Only load from DB if arrays are empty to avoid overwriting newly added files
      if (offlineTracks.length === 0) {
        offlineTracks = dbTracks;
        console.log('Loaded tracks from DB:', offlineTracks.length);
      } else {
        console.log('Keeping existing tracks in memory:', offlineTracks.length);
      }

      if (offlineVideos.length === 0) {
        offlineVideos = dbVideos;
        console.log('Loaded videos from DB:', offlineVideos.length);
      } else {
        console.log('Keeping existing videos in memory:', offlineVideos.length);
      }

      console.log('After initialization - offlineTracks:', offlineTracks.length);
      console.log('After initialization - offlineVideos:', offlineVideos.length);
      queue = [...offlineTracks];

      renderOfflineLibrary();
      renderOfflineVideoLibrary();

      console.log('Final counts:', offlineTracks.length, 'tracks,', offlineVideos.length, 'videos');
    } catch (error) {
      console.error('Error initializing libraries:', error);
      renderOfflineLibrary();
      renderOfflineVideoLibrary();
    }
  }

  // Update all cover images to use the uploaded image
  function updateAllCoverImages() {
    const newCoverImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=';
    document.querySelectorAll('img[src*="data:image/svg+xml"]').forEach(img => {
      if (img.alt === 'Cover' || img.classList.contains('player-cover')) {
        img.src = newCoverImage;
      }
    });
  }

  // Call the function to update covers
  setTimeout(updateAllCoverImages, 100);

  console.log(' Enhanced offline system initialized successfully');

console.log(' Complete enhanced offline system loaded');

// Database functions
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('HertzOfflineDB', 1);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('tracks')) {
        db.createObjectStore('tracks', { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains('videos')) {
        db.createObjectStore('videos', { keyPath: 'id' });
      }
    };
  });
}

async function saveTrackToDB(track) {
  try {
    const db = await initDB();
    const transaction = db.transaction(['tracks'], 'readwrite');
    const store = transaction.objectStore('tracks');
    store.put(track);
  } catch (error) {
    console.log('Fallback to localStorage for track:', track.id);
    localStorage.setItem('hertz_track_' + track.id, JSON.stringify(track));
  }
}

async function saveVideoToDB(video) {
  try {
    const db = await initDB();
    const transaction = db.transaction(['videos'], 'readwrite');
    const store = transaction.objectStore('videos');
    store.put(video);
  } catch (error) {
    console.log('Fallback to localStorage for video:', video.id);
    localStorage.setItem('hertz_video_' + video.id, JSON.stringify(video));
  }
}

async function loadTracksFromDB() {
  try {
    const db = await initDB();
    const transaction = db.transaction(['tracks'], 'readonly');
    const store = transaction.objectStore('tracks');
    const request = store.getAll();

    return new Promise((resolve) => {
      request.onsuccess = () => resolve(request.result || []);
      request.onerror = () => {
        console.log('Fallback to localStorage for tracks');
        const tracks = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('hertz_track_')) {
            try {
              tracks.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {
              console.error('Error parsing track from localStorage:', e);
            }
          }
        }
        resolve(tracks);
      };
    });
  } catch (error) {
    console.log('Database unavailable, using localStorage');
    const tracks = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('hertz_track_')) {
        try {
          tracks.push(JSON.parse(localStorage.getItem(key)));
        } catch (e) {
          console.error('Error parsing track from localStorage:', e);
        }
      }
    }
    return tracks;
  }
}

async function loadVideosFromDB() {
  try {
    const db = await initDB();
    const transaction = db.transaction(['videos'], 'readonly');
    const store = transaction.objectStore('videos');
    const request = store.getAll();

    return new Promise((resolve) => {
      request.onsuccess = () => resolve(request.result || []);
      request.onerror = () => {
        console.log('Fallback to localStorage for videos');
        const videos = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('hertz_video_')) {
            try {
              videos.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {
              console.error('Error parsing video from localStorage:', e);
            }
          }
        }
        resolve(videos);
      };
    });
  } catch (error) {
    console.log('Database unavailable, using localStorage');
    const videos = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('hertz_video_')) {
        try {
          videos.push(JSON.parse(localStorage.getItem(key)));
        } catch (e) {
          console.error('Error parsing video from localStorage:', e);
        }
      }
    }
    return videos;
  }
}

// Render functions
function renderOfflineLibrary() {
  console.log('=== RENDERING OFFLINE LIBRARY ===');
  console.log('offlineTracks array:', offlineTracks);
  console.log('Number of tracks:', offlineTracks.length);

  const libraryElement = document.getElementById('offlineLibrary');
  const trackCountElement = document.getElementById('trackCount');
  const emptyMusicMessage = document.getElementById('emptyMusicMessage');

  if (!libraryElement) {
    console.error(' Library element not found - ID: offlineLibrary');
    console.log('Available elements with IDs:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
    return;
  }

  console.log(' Library element found:', libraryElement);

  // Update track count
  if (trackCountElement) {
    trackCountElement.textContent = `${offlineTracks.length} track${offlineTracks.length !== 1 ? 's' : ''}`;
  }

  if (offlineTracks.length === 0) {
    console.log('No tracks to display, showing empty message');
    if (emptyMusicMessage) {
      libraryElement.innerHTML = '';
      libraryElement.appendChild(emptyMusicMessage);
    } else {
      libraryElement.innerHTML = '<div style="text-align:center;color:#b3b3b3;padding:2rem;">No offline tracks yet. Upload some music files to get started!</div>';
    }
    return;
  }

  // Reduce logging frequency for large libraries
  if (offlineTracks.length <= 10) {
    console.log('Rendering', offlineTracks.length, 'tracks');
  } else {
    console.log('Rendering large library:', offlineTracks.length, 'tracks (logging reduced)');
  }

  // Hide empty message and render tracks
  if (emptyMusicMessage) {
    emptyMusicMessage.style.display = 'none';
  }

  let html = '';
  offlineTracks.forEach((track, index) => {
    // Reduce individual track logging for large libraries to prevent DevTools overload
    if (offlineTracks.length <= 10 || index === 0 || index === offlineTracks.length - 1) {
      console.log(`Rendering track ${index + 1}:`, track.name);
    }
    const isSelected = selectedTracks.has(track.id);
    html += `
      <div class="offline-track" style="display:flex;align-items:center;gap:1rem;flex:1;${isSelectionMode ? 'padding-left:35px;' : ''}" onclick="playTrack('${track.id}')" style="cursor:pointer;">
        ${isSelectionMode ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTrackSelection('${track.id}')" onclick="event.stopPropagation()">` : ''}
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ29sZGVuIiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQTUwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNEQTdGMDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izg4NEQwMDtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDAwMDAwIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0idXJsKCNnb2xkZW4pIi8+CiAgPHRleHQgeD0iMTAwIiB5PSIxMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwMDAwMDAiPkhaPC90ZXh0Pgo8L3N2Zz4=" alt="Cover" style="width:48px;height:48px;border-radius:6px;object-fit:cover;">
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;color:#fff;margin-bottom:0.2rem;">${track.name}</div>
          <div style="font-size:0.9rem;color:#b3b3b3;">${track.artist || 'Unknown Artist'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:0.5rem;">
          <button onclick="toggleLike('${track.id}')" class="like-btn" style="color:${track.liked ? '#fff700' : '#ff4081'};font-size:1.3rem;background:none;border:none;cursor:pointer;transition:color 0.2s;" title="Like"></button>
          <button onclick="toggleTrackMenu('${track.id}'); event.stopPropagation();" style="background:none;border:none;color:#b3b3b3;font-size:1.2rem;cursor:pointer;padding:4px;" title="More options"></button>
        </div>

        <!-- Track Menu -->
        <div id="menu-${track.id}" class="track-menu-popup" style="display:none;position:absolute;right:20px;top:60px;background:#2a2a2a;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.4);z-index:1000;min-width:180px;border:1px solid #404040;">
          <div onclick="likeTrack('${track.id}')" class="track-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;">
            <span>${track.liked ? '' : ''}</span> ${track.liked ? 'Unlike' : 'Like'}
          </div>
          <div onclick="addToQueue('${track.id}')" class="track-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;">
            <span></span> Add to Queue
          </div>
          <div onclick="shareTrack('${track.id}', event)" class="track-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;">
            <span></span> Share
          </div>
          <div onclick="removeTrack('${track.id}')" class="track-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;color:#f44336;">
            <span></span> Remove
          </div>
        </div>
      </div>
    `;
  });

  console.log('Generated HTML length:', html.length);
  libraryElement.innerHTML = html;
  console.log(' Library rendered successfully');
}

// Force render function to ensure tracks display
function forceRenderLibraries() {
  console.log('=== FORCE RENDERING LIBRARIES ===');
  console.log('Current offlineTracks:', offlineTracks.length);
  console.log('Current offlineVideos:', offlineVideos.length);

  // Force update the queue
  queue = [...offlineTracks];

  // Render multiple times to ensure display
  renderOfflineLibrary();
  renderOfflineVideoLibrary();

  setTimeout(() => {
    renderOfflineLibrary();
    renderOfflineVideoLibrary();
  }, 100);

  setTimeout(() => {
    renderOfflineLibrary();
    renderOfflineVideoLibrary();
  }, 500);
}

// Make force render globally available for debugging
window.forceRenderLibraries = forceRenderLibraries;

// Helper function to format file sizes
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderOfflineVideoLibrary() {
  console.log('=== RENDERING OFFLINE VIDEO LIBRARY ===');
  console.log('offlineVideos array:', offlineVideos);
  console.log('Number of videos:', offlineVideos.length);

  const libraryElement = document.getElementById('offlineVideoLibrary');
  const videoCountElement = document.getElementById('videoCount');
  const emptyVideoMessage = document.getElementById('emptyVideoMessage');

  if (!libraryElement) {
    console.error(' Video library element not found - ID: offlineVideoLibrary');
    return;
  }

  console.log(' Video library element found:', libraryElement);

  // Update video count
  if (videoCountElement) {
    videoCountElement.textContent = `${offlineVideos.length} video${offlineVideos.length !== 1 ? 's' : ''}`;
  }

  if (offlineVideos.length === 0) {
    if (emptyVideoMessage) {
      libraryElement.innerHTML = '';
      libraryElement.appendChild(emptyVideoMessage);
    } else {
      libraryElement.innerHTML = '<div style="text-align:center;color:#b3b3b3;padding:2rem;">No offline videos yet. Upload some video files to get started!</div>';
    }
    return;
  }

  // Hide empty message and render videos
  if (emptyVideoMessage) {
    emptyVideoMessage.style.display = 'none';
  }

  let html = '';
  offlineVideos.forEach((video, index) => {
    // Reduce individual video logging for large libraries to prevent DevTools overload
    if (offlineVideos.length <= 10 || index === 0 || index === offlineVideos.length - 1) {
      console.log(`Rendering video ${index + 1}:`, video.name);
    }
    html += `
      <div class="video-item" onclick="playOfflineVideo('${video.id}')" style="position:relative;margin-bottom:10px;cursor:pointer;">
        <div class="video-square" style="position:relative;width:100%;height:120px;background:#333;border-radius:8px;overflow:hidden;">
          <video preload="metadata" style="width:100%;height:100%;object-fit:cover;" muted>
            <source src="${video.url}" type="${video.type}">
          </video>
          <div class="video-play-btn" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;color:#333;"></div>
          <div class="video-title" style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.8));color:#fff;padding:8px;font-size:14px;font-weight:600;">${video.name}</div>
        </div>

        <!-- Video Menu Button -->
        <button onclick="toggleVideoMenu('${video.id}', event)" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;"></button>

        <!-- Video Menu -->
        <div id="video-menu-${video.id}" class="video-menu-popup" style="display:none;position:absolute;right:20px;top:40px;background:#2a2a2a;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.4);z-index:1000;min-width:150px;border:1px solid #404040;">
          <div onclick="shareVideo('${video.id}')" class="video-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;">
            <span></span> Share
          </div>
          <div onclick="removeVideo('${video.id}')" class="video-menu-option" style="padding:0.7rem 1rem;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:0.5rem;color:#f44336;">
            <span></span> Remove
          </div>
        </div>
      </div>
    `;
  });

  console.log('Generated HTML length:', html.length);
  libraryElement.innerHTML = html;
  console.log(' Video library rendered successfully');
}

// Enhanced play track function
window.playTrack = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (!track) return;

  currentTrack = track;
  currentIndex = queue.findIndex(t => t.id === trackId);
  if (currentIndex === -1) currentIndex = 0;

  const stickyPlayer = document.getElementById('stickyPlayer');
  const playerTitle = document.getElementById('playerTrackTitle');
  const playerAudio = document.getElementById('playerAudio');

  if (stickyPlayer && playerAudio) {
    stickyPlayer.style.display = 'flex';
    if (playerTitle) playerTitle.textContent = track.name;
    playerAudio.src = track.base64;
    playerAudio.play().then(() => {
      // Activate bass detection for cover pulsing
      connectAudioToAnalyser();
      // detectBassAndPulse(); // Disabled for maximum stability
    }).catch(console.error);
    isPlaying = true;
    // showNotification(`Now playing: ${track.name}`, 'success'); // Removed notification
  }

// Enhanced play video function
window.playVideo = function(videoId) {
  const video = offlineVideos.find(v => v.id === videoId);
  if (!video) return;

  // Create a video player modal
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2000;display:flex;align-items:center;justify-content:center;';
  modal.onclick = () => document.body.removeChild(modal);

  const videoElement = document.createElement('video');
  videoElement.style.cssText = 'max-width:90%;max-height:90%;border-radius:8px;';
  videoElement.controls = true;
  videoElement.autoplay = true;
  videoElement.src = video.url;

  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '';
  closeBtn.style.cssText = 'position:absolute;top:20px;right:20px;background:#e22134;color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer;z-index:2001;';
  closeBtn.onclick = (e) => {
    e.stopPropagation();
    document.body.removeChild(modal);
  };

  modal.appendChild(videoElement);
  modal.appendChild(closeBtn);
  document.body.appendChild(modal);

  // showNotification(`Playing video: ${video.name}`, 'success'); // Removed notification


// Enhanced toggle like function
window.toggleLike = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (track) {
    track.liked = !track.liked;
    const likeBtn = document.querySelector(`button[onclick="toggleLike('${trackId}')"]`);
    if (likeBtn) {
      likeBtn.style.color = track.liked ? '#fff700' : '#ff4081';
      likeBtn.classList.add('like-btn-pop');
      setTimeout(() => likeBtn.classList.remove('like-btn-pop'), 350);
    }
    saveTrackToDB(track);
    showNotification(track.liked ? 'Added to liked tracks' : 'Removed from liked tracks', 'success');
  }
};

// Toggle track menu function
window.toggleTrackMenu = function(trackId) {
  const menu = document.getElementById(`menu-${trackId}`);
  if (menu) {
    const isVisible = menu.style.display === 'block';
    // Close all other menus
    document.querySelectorAll('.track-menu-popup').forEach(m => m.style.display = 'none');
    menu.style.display = isVisible ? 'none' : 'block';
  }
};

// Track menu functions
window.likeTrack = function(trackId) {
  toggleLike(trackId);
  toggleTrackMenu(trackId);
};

window.addToQueue = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (track) {
    queue.push(track);
    showNotification(`Added "${track.name}" to queue`, 'success');
  }
  toggleTrackMenu(trackId);
};

window.shareTrack = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (track) {
    if (navigator.share) {
      navigator.share({
        title: track.name,
        text: `Check out "${track.name}" by ${track.artist || 'Unknown Artist'}`,
      });
    } else {
      showNotification('Sharing not supported on this device', 'error');
    }
  }
  toggleTrackMenu(trackId);
};

window.removeTrack = function(trackId) {
  const trackIndex = offlineTracks.findIndex(t => t.id === trackId);
  if (trackIndex === -1) return;

  const track = offlineTracks[trackIndex];
  if (confirm(`Remove "${track.name}" from your library?`)) {
    offlineTracks.splice(trackIndex, 1);
    queue = [...offlineTracks];

    // Update localStorage
    localStorage.setItem('offlineTracks', JSON.stringify(offlineTracks));

    // Remove from IndexedDB
    removeTrackFromDB(trackId);

    renderOfflineLibrary();
    showNotification(`Removed: ${track.name}`, 'success');
  }
  toggleTrackMenu(trackId);
};

// Video menu functions
window.toggleVideoMenu = function(videoId, event) {
  if (event) event.stopPropagation();
  const menu = document.getElementById(`video-menu-${videoId}`);
  if (menu) {
    const isVisible = menu.style.display === 'block';
    // Close all other menus
    document.querySelectorAll('.video-menu-popup').forEach(m => m.style.display = 'none');
    menu.style.display = isVisible ? 'none' : 'block';
  }
};

window.shareVideo = function(videoId) {
  const video = offlineVideos.find(v => v.id === videoId);
  if (video) {
    if (navigator.share) {
      navigator.share({
        title: video.name,
        text: `Check out this video: "${video.name}"`,
      });
    } else {
      showNotification('Sharing not supported on this device', 'error');
    }
  }
  toggleVideoMenu(videoId);
};

window.removeVideo = function(videoId) {
  const videoIndex = offlineVideos.findIndex(v => v.id === videoId);
  if (videoIndex === -1) return;

  const video = offlineVideos[videoIndex];
  if (confirm(`Remove "${video.name}" from your library?`)) {
    offlineVideos.splice(videoIndex, 1);

    // Update localStorage
    localStorage.setItem('offlineVideos', JSON.stringify(offlineVideos));

    // Remove from IndexedDB
    removeVideoFromDB(videoId);

    renderOfflineVideoLibrary();
    showNotification(`Removed: ${video.name}`, 'success');
  }
  toggleVideoMenu(videoId);
};// Play offline track function
window.playOfflineTrack = function(trackId) {
  console.log('=== PLAYING OFFLINE TRACK ===');
  console.log('Track ID:', trackId);

  const track = offlineTracks.find(t => t.id === trackId);
  if (!track) {
    console.error(' Track not found:', trackId);
    showNotification('Track not found!', 'error');
    return;
  }

  console.log(' Found track:', track.name);

  currentTrack = track;
  currentIndex = offlineTracks.findIndex(t => t.id === trackId);
  if (currentIndex === -1) currentIndex = 0;

  const stickyPlayer = document.getElementById('stickyPlayer');
  const playerTitle = document.getElementById('playerTrackTitle');
  const playerArtist = document.getElementById('playerArtist');
  const playerAudio = document.getElementById('playerAudio');

  if (stickyPlayer && playerAudio) {
    console.log('Setting up player...');
    stickyPlayer.style.display = 'flex';
    if (playerTitle) playerTitle.textContent = track.name;
    if (playerArtist) playerArtist.textContent = track.artist || 'Unknown Artist';

    playerAudio.src = track.base64;
    playerAudio.play().then(() => {
      console.log(' Track started playing');
      isPlaying = true;
      // showNotification(`Now playing: ${track.name}`, 'success'); // Removed notification

      // Activate bass detection for cover pulsing
      connectAudioToAnalyser();
      // detectBassAndPulse(); // Disabled for maximum stability
    }).catch(error => {
      console.error(' Playback error:', error);
      showNotification('Playback error occurred', 'error');
    });
  }
};

// Enhanced YouTube-style video player function
window.playOfflineVideo = function(videoId) {
  console.log('=== PLAYING OFFLINE VIDEO ===');
  console.log('Video ID:', videoId);

  const video = offlineVideos.find(v => v.id === videoId);
  if (!video) {
    console.error(' Video not found:', videoId);
    showNotification('Video not found!', 'error');
    return;
  }

  console.log(' Found video:', video.name);

  // Remove any existing video player
  const existingPlayer = document.querySelector('.youtube-video-player');
  if (existingPlayer) {
    existingPlayer.remove();
  }

  // Create backdrop overlay (only visible when expanded)
  const backdrop = document.createElement('div');
  backdrop.className = 'youtube-backdrop';
  backdrop.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 4999;
    display: none;
    backdrop-filter: blur(5px);
  `;

  // Create YouTube-style video player
  const playerContainer = document.createElement('div');
  playerContainer.className = 'youtube-video-player';

  const videoContainer = document.createElement('div');
  videoContainer.className = 'youtube-video-container';

  // Create video element - Start muted and auto-play
  const videoElement = document.createElement('video');
  videoElement.className = 'youtube-video-element';
  videoElement.src = video.url;
  videoElement.preload = 'metadata';
  videoElement.muted = true; // Start muted to not interfere with music
  videoElement.autoplay = true; // Enable auto-play attribute
  videoElement.loop = true; // Enable auto-loop
  videoElement.playsInline = true; // For mobile compatibility
  videoElement.volume = 0.1; // Low volume initially

  // Loading spinner
  const loadingSpinner = document.createElement('div');
  loadingSpinner.className = 'youtube-loading';

  // Title bar with minimize and close buttons
  const titleBar = document.createElement('div');
  titleBar.className = 'youtube-title-bar';
  titleBar.innerHTML = `
    <h3 class="youtube-video-title">${video.name}</h3>
    <div class="youtube-top-controls">
      <button class="youtube-minimize-btn" title="Expand"></button>
      <button class="youtube-close-btn" title="Close"></button>
    </div>
  `;

  // Video controls
  const controlsContainer = document.createElement('div');
  controlsContainer.className = 'youtube-video-controls';
  controlsContainer.innerHTML = `
    <div class="youtube-progress-container">
      <div class="youtube-progress-bar">
        <div class="youtube-progress-handle"></div>
      </div>
    </div>
    <div class="youtube-control-buttons">
      <div class="youtube-control-left">
        <button class="youtube-control-btn youtube-play-btn"></button>
        <div class="youtube-volume-container">
          <button class="youtube-control-btn youtube-volume-btn"></button>
          <input type="range" class="youtube-volume-slider" min="0" max="100" value="50">
        </div>
        <span class="youtube-time-display">0:00 / 0:00</span>
      </div>
      <div class="youtube-control-right">
        <button class="youtube-control-btn youtube-fullscreen-btn" title="Fullscreen"></button>
      </div>
    </div>
  `;

  // Create mini player controls (for mini mode only)
  const miniControlsContainer = document.createElement('div');
  miniControlsContainer.className = 'youtube-mini-controls';
  miniControlsContainer.innerHTML = `
    <div class="youtube-mini-drag-handle" title="Drag to move"></div>
    <div class="youtube-mini-progress">
      <div class="youtube-mini-progress-bar"></div>
    </div>
    <div class="youtube-mini-controls-left">
      <button class="youtube-mini-btn youtube-mini-unmute-btn" title="Unmute"></button>
      <span class="youtube-mini-time">0:00 / 0:00</span>
    </div>
    <div class="youtube-mini-controls-right">
      <button class="youtube-mini-btn youtube-mini-close-btn" title="Close"></button>
    </div>
  `;

  // Assemble the player
  videoContainer.appendChild(loadingSpinner);
  videoContainer.appendChild(videoElement);
  videoContainer.appendChild(titleBar);
  videoContainer.appendChild(controlsContainer);
  videoContainer.appendChild(miniControlsContainer);
  playerContainer.appendChild(videoContainer);

  // Add to document
  document.body.appendChild(backdrop);
  document.body.appendChild(playerContainer);

  // Get control elements
  const playBtn = controlsContainer.querySelector('.youtube-play-btn');
  const volumeBtn = controlsContainer.querySelector('.youtube-volume-btn');
  const volumeSlider = controlsContainer.querySelector('.youtube-volume-slider');
  const timeDisplay = controlsContainer.querySelector('.youtube-time-display');
  const progressContainer = controlsContainer.querySelector('.youtube-progress-container');
  const progressBar = controlsContainer.querySelector('.youtube-progress-bar');
  const progressHandle = controlsContainer.querySelector('.youtube-progress-handle');
  const fullscreenBtn = controlsContainer.querySelector('.youtube-fullscreen-btn');
  const minimizeBtn = titleBar.querySelector('.youtube-minimize-btn');
  const closeBtn = titleBar.querySelector('.youtube-close-btn');

  // Get mini control elements
  const miniUnmuteBtn = miniControlsContainer.querySelector('.youtube-mini-unmute-btn');
  const miniTimeDisplay = miniControlsContainer.querySelector('.youtube-mini-time');
  const miniCloseBtn = miniControlsContainer.querySelector('.youtube-mini-close-btn');
  const miniProgressContainer = miniControlsContainer.querySelector('.youtube-mini-progress');
  const miniProgressBar = miniControlsContainer.querySelector('.youtube-mini-progress-bar');
  const dragHandle = miniControlsContainer.querySelector('.youtube-mini-drag-handle');

  // Video state - Start in mini player mode by default
  let isVideoPlaying = false; // Renamed to avoid conflict with audio player
  let isMuted = true; // Start muted to not interfere with music
  let isMinimized = true;
  let isFullscreen = false;
  let hideControlsTimeout;

  // Drag functionality variables
  let isDragging = false;
  let dragJustCompleted = false;
  let dragOffset = { x: 0, y: 0 };
  let currentPosition = { x: 0, y: 0 };

  // Helper functions
  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function updateProgress() {
    if (videoElement.duration) {
      const progress = (videoElement.currentTime / videoElement.duration) * 100;
      progressBar.style.width = progress + '%';
      timeDisplay.textContent = `${formatTime(videoElement.currentTime)} / ${formatTime(videoElement.duration)}`;

      // Update mini controls as well
      miniProgressBar.style.width = progress + '%';
      miniTimeDisplay.textContent = `${formatTime(videoElement.currentTime)} / ${formatTime(videoElement.duration)}`;
    }
  }

  function showControls() {
    controlsContainer.classList.add('show');
    titleBar.classList.add('show');
    miniControlsContainer.classList.add('show');
    clearTimeout(hideControlsTimeout);

    if (!isMinimized) {
      hideControlsTimeout = setTimeout(() => {
        if (isVideoPlaying) {
          controlsContainer.classList.remove('show');
          titleBar.classList.remove('show');
        }
      }, 3000);
    } else {
      // In mini mode, keep mini controls visible briefly
      setTimeout(() => {
        miniControlsContainer.classList.remove('show');
      }, 2000);
    }
  }

  function hideControls() {
    if (isVideoPlaying && !isMinimized) {
      controlsContainer.classList.remove('show');
      titleBar.classList.remove('show');
    }
  }

  // Event listeners
  videoElement.addEventListener('loadedmetadata', () => {
    loadingSpinner.style.display = 'none';
    timeDisplay.textContent = `0:00 / ${formatTime(videoElement.duration)}`;
  });

  videoElement.addEventListener('timeupdate', updateProgress);

  videoElement.addEventListener('loadstart', () => {
    loadingSpinner.style.display = 'block';
  });

  videoElement.addEventListener('canplay', () => {
    loadingSpinner.style.display = 'none';
    // Ensure auto-play starts when video is ready
    if (videoElement.paused && isVideoPlaying) {
      videoElement.play().catch(console.error);
    }
  });

  videoElement.addEventListener('loadedmetadata', () => {
    loadingSpinner.style.display = 'none';
    // Additional auto-play trigger when metadata is loaded
    if (videoElement.paused) {
      videoElement.play().then(() => {
        playBtn.textContent = '';
        isVideoPlaying = true;
      }).catch(console.error);
    }
  });

  // Play/Pause functionality
  playBtn.addEventListener('click', () => {
    if (isVideoPlaying) {
      videoElement.pause();
      playBtn.textContent = '';
      isVideoPlaying = false;
    } else {
      // Unmute when user manually starts video
      if (videoElement.muted) {
        videoElement.muted = false;
        isMuted = false;
        volumeBtn.textContent = '';
      }
      videoElement.play();
      playBtn.textContent = '';
      isVideoPlaying = true;
      hideControls();
    }
  });

  // Video click to play/pause
  videoElement.addEventListener('click', () => {
    if (!isMinimized) {
      playBtn.click();
    }
  });

  // Volume control
  volumeBtn.addEventListener('click', () => {
    if (isMuted) {
      videoElement.muted = false;
      volumeBtn.textContent = '';
      volumeSlider.value = videoElement.volume * 100;
      isMuted = false;
    } else {
      videoElement.muted = true;
      volumeBtn.textContent = '';
      isMuted = true;
    }
  });

  volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    videoElement.volume = volume;
    videoElement.muted = false;
    isMuted = false;
    volumeBtn.textContent = volume > 0 ? '' : '';
  });

  // Progress bar interaction
  progressContainer.addEventListener('click', (e) => {
    const rect = progressContainer.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * videoElement.duration;
    videoElement.currentTime = newTime;
  });

  // Mini controls functionality
  miniUnmuteBtn.addEventListener('click', () => {
    if (isMuted) {
      videoElement.muted = false;
      isMuted = false;
      miniUnmuteBtn.textContent = '';
      volumeBtn.textContent = '';
    } else {
      videoElement.muted = true;
      isMuted = true;
      miniUnmuteBtn.textContent = '';
      volumeBtn.textContent = '';
    }
  });

  miniCloseBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    backdrop.remove();
    playerContainer.remove();
  });

  // Mini progress bar interaction
  miniProgressContainer.addEventListener('click', (e) => {
    const rect = miniProgressContainer.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * videoElement.duration;
    videoElement.currentTime = newTime;
  });

  // Drag functionality for mini player
  dragHandle.addEventListener('mousedown', (e) => {
    if (!isMinimized) return; // Only allow dragging in mini mode

    e.preventDefault();
    e.stopPropagation();
    isDragging = true;

    const rect = playerContainer.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;

    playerContainer.classList.add('dragging');
    document.body.style.userSelect = 'none';

    // Calculate current position from CSS
    const computedStyle = window.getComputedStyle(playerContainer);
    currentPosition.x = rect.left;
    currentPosition.y = rect.top;
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging || !isMinimized) return;

    e.preventDefault();

    // Calculate new position
    const newX = e.clientX - dragOffset.x;
    const newY = e.clientY - dragOffset.y;

    // Constrain to viewport
    const maxX = window.innerWidth - playerContainer.offsetWidth;
    const maxY = window.innerHeight - playerContainer.offsetHeight;

    currentPosition.x = Math.max(0, Math.min(maxX, newX));
    currentPosition.y = Math.max(0, Math.min(maxY, newY));

    // Update position
    playerContainer.style.left = currentPosition.x + 'px';
    playerContainer.style.top = currentPosition.y + 'px';
    playerContainer.style.right = 'auto';
    playerContainer.style.bottom = 'auto';
  });

  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      dragJustCompleted = true;
      playerContainer.classList.remove('dragging');
      document.body.style.userSelect = '';

      // Reset the flag after a short delay to allow click event to check it
      setTimeout(() => {
        dragJustCompleted = false;
      }, 10);
    }
  });

  // Touch support for mobile
  dragHandle.addEventListener('touchstart', (e) => {
    if (!isMinimized) return;

    e.preventDefault();
    const touch = e.touches[0];
    const rect = playerContainer.getBoundingClientRect();

    isDragging = true;
    dragOffset.x = touch.clientX - rect.left;
    dragOffset.y = touch.clientY - rect.top;

    playerContainer.classList.add('dragging');
    currentPosition.x = rect.left;
    currentPosition.y = rect.top;
  });

  document.addEventListener('touchmove', (e) => {
    if (!isDragging || !isMinimized) return;

    e.preventDefault();
    const touch = e.touches[0];

    const newX = touch.clientX - dragOffset.x;
    const newY = touch.clientY - dragOffset.y;

    const maxX = window.innerWidth - playerContainer.offsetWidth;
    const maxY = window.innerHeight - playerContainer.offsetHeight;

    currentPosition.x = Math.max(0, Math.min(maxX, newX));
    currentPosition.y = Math.max(0, Math.min(maxY, newY));

    playerContainer.style.left = currentPosition.x + 'px';
    playerContainer.style.top = currentPosition.y + 'px';
    playerContainer.style.right = 'auto';
    playerContainer.style.bottom = 'auto';
  });

  document.addEventListener('touchend', () => {
    if (isDragging) {
      isDragging = false;
      dragJustCompleted = true;
      playerContainer.classList.remove('dragging');

      // Reset the flag after a short delay to allow click event to check it
      setTimeout(() => {
        dragJustCompleted = false;
      }, 10);
    }
  });

  // Fullscreen functionality
  fullscreenBtn.addEventListener('click', () => {
    if (!isFullscreen) {
      if (videoContainer.requestFullscreen) {
        videoContainer.requestFullscreen();
      } else if (videoContainer.webkitRequestFullscreen) {
        videoContainer.webkitRequestFullscreen();
      } else if (videoContainer.msRequestFullscreen) {
        videoContainer.msRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  });

  // Expand/Minimize functionality
  minimizeBtn.addEventListener('click', () => {
    if (isMinimized) {
      // Expand to full player
      isMinimized = false;
      videoContainer.classList.add('expanded');
      backdrop.style.display = 'block';
      playerContainer.style.background = 'transparent';
      playerContainer.style.position = 'fixed';
      playerContainer.style.top = '0';
      playerContainer.style.left = '0';
      playerContainer.style.width = '100%';
      playerContainer.style.height = '100%';
      playerContainer.style.display = 'flex';
      playerContainer.style.alignItems = 'center';
      playerContainer.style.justifyContent = 'center';
      playerContainer.style.pointerEvents = 'auto'; // Enable clicks in expanded mode
      minimizeBtn.textContent = '';
      minimizeBtn.title = 'Minimize';
    } else {
      // Minimize to corner
      isMinimized = true;
      videoContainer.classList.remove('expanded');
      backdrop.style.display = 'none';
      playerContainer.style.background = 'transparent';
      playerContainer.style.position = 'fixed';
      playerContainer.style.top = 'auto';
      playerContainer.style.left = 'auto';
      playerContainer.style.bottom = '20px';
      playerContainer.style.right = '20px';
      playerContainer.style.width = '360px';
      playerContainer.style.height = 'auto';
      playerContainer.style.display = 'block';
      playerContainer.style.alignItems = 'initial';
      playerContainer.style.justifyContent = 'initial';
      playerContainer.style.pointerEvents = 'none'; // Allow clicks to pass through in mini mode
      minimizeBtn.textContent = '';
      minimizeBtn.title = 'Expand';
    }
    showControls();
  });

  // Expand from mini player when clicked (but not on controls)
  videoContainer.addEventListener('click', (e) => {
    // Prevent expanding if drag just completed
    if (dragJustCompleted) {
      dragJustCompleted = false;
      return;
    }

    if (isMinimized && !e.target.closest('.youtube-video-controls') && !e.target.closest('.youtube-title-bar')) {
      // Expand to full player
      isMinimized = false;
      videoContainer.classList.add('expanded');
      backdrop.style.display = 'block';
      playerContainer.style.background = 'transparent';
      playerContainer.style.position = 'fixed';
      playerContainer.style.top = '0';
      playerContainer.style.left = '0';
      playerContainer.style.width = '100%';
      playerContainer.style.height = '100%';
      playerContainer.style.display = 'flex';
      playerContainer.style.alignItems = 'center';
      playerContainer.style.justifyContent = 'center';
      playerContainer.style.pointerEvents = 'auto'; // Enable clicks in expanded mode
      minimizeBtn.textContent = '';
      minimizeBtn.title = 'Minimize';
    }
  });

  // Close functionality
  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    backdrop.remove();
    playerContainer.remove();
  });

  // Close when clicking backdrop in expanded mode
  backdrop.addEventListener('click', () => {
    backdrop.remove();
    playerContainer.remove();
  });

  // Close when clicking outside in expanded mode only
  playerContainer.addEventListener('click', (e) => {
    if (e.target === playerContainer && !isMinimized) {
      backdrop.remove();
      playerContainer.remove();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function handleVideoKeydown(e) {
    if (!document.querySelector('.youtube-video-player')) {
      document.removeEventListener('keydown', handleVideoKeydown);
      return;
    }

    switch(e.code) {
      case 'Space':
        e.preventDefault();
        playBtn.click();
        break;
      case 'Escape':
        if (isFullscreen) {
          fullscreenBtn.click();
        } else {
          closeBtn.click();
        }
        break;
      case 'KeyF':
        fullscreenBtn.click();
        break;
      case 'KeyM':
        volumeBtn.click();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        videoElement.currentTime = Math.max(0, videoElement.currentTime - 10);
        break;
      case 'ArrowRight':
        e.preventDefault();
        videoElement.currentTime = Math.min(videoElement.duration, videoElement.currentTime + 10);
        break;
    }
  });

  // Fullscreen change events
  document.addEventListener('fullscreenchange', () => {
    isFullscreen = !!document.fullscreenElement;
    fullscreenBtn.textContent = isFullscreen ? '' : '';
  });

  // Mouse movement shows controls
  videoContainer.addEventListener('mousemove', showControls);
  videoContainer.addEventListener('mouseenter', showControls);
  videoContainer.addEventListener('mouseleave', () => {
    if (!isMinimized) {
      hideControlsTimeout = setTimeout(hideControls, 1000);
    } else {
      // Hide mini controls after a short delay
      setTimeout(() => {
        if (!miniControlsContainer.matches(':hover')) {
          miniControlsContainer.classList.remove('show');
        }
      }, 1500);
    }
  });

  // Auto-play video muted in mini mode (as requested)
  // Using both HTML autoplay attribute and JavaScript for maximum compatibility
  videoElement.play().then(() => {
    playBtn.textContent = '';
    isVideoPlaying = true;
    showControls();
  }).catch(error => {
    console.error('Auto-play failed:', error);
    // If auto-play fails, ensure the video is ready to play on user interaction
    showControls();
  });

  // Initial setup - Start in mini player mode
  videoElement.volume = 0.1; // Low initial volume

  // Initialize mini player appearance
  minimizeBtn.textContent = '';
  minimizeBtn.title = 'Expand';

  // Initialize volume button to show muted state
  volumeBtn.textContent = '';

  // Start in mini mode - no background overlay
  playerContainer.style.background = 'transparent';

  showControls();
};

// Remove offline track function
window.removeOfflineTrack = function(trackId) {
  const trackIndex = offlineTracks.findIndex(t => t.id === trackId);
  if (trackIndex === -1) return;

  const track = offlineTracks[trackIndex];
  if (confirm(`Remove "${track.name}" from your library?`)) {
    offlineTracks.splice(trackIndex, 1);

    // Update localStorage
    localStorage.setItem('offlineTracks', JSON.stringify(offlineTracks));

    // Remove from IndexedDB
    removeTrackFromDB(trackId);

    renderOfflineLibrary();
    showNotification(`Removed: ${track.name}`, 'success');
  }
};

// Remove offline video function
window.removeOfflineVideo = function(videoId) {
  const videoIndex = offlineVideos.findIndex(v => v.id === videoId);
  if (videoIndex === -1) return;

  const video = offlineVideos[videoIndex];
  if (confirm(`Remove "${video.name}" from your library?`)) {
    offlineVideos.splice(videoIndex, 1);

    // Update localStorage
    localStorage.setItem('offlineVideos', JSON.stringify(offlineVideos));

    // Remove from IndexedDB
    removeVideoFromDB(videoId);

    renderOfflineVideoLibrary();
    showNotification(`Removed: ${video.name}`, 'success');
  }
};

// Track selection functionality
window.toggleTrackSelection = function(trackId) {
  if (selectedTracks.has(trackId)) {
    selectedTracks.delete(trackId);
  } else {
    selectedTracks.add(trackId);
  }
  updateSelectAllButton();
};

// Enhanced play track function
// OVERRIDE: Only use the popup social media share logic (see earlier definition)
// This is intentionally left blank to prevent clipboard or play logic from running.
    stickyPlayer.style.display = 'flex';
    if (playerTitle) playerTitle.textContent = track.name;
    if (popupTitle) popupTitle.textContent = track.name;

    // Update like button states
    const popupLikeBtn = document.getElementById('popupLikeBtn');
    const stickyLikeBtn = document.getElementById('likeBtnSticky');
    if (popupLikeBtn) {
      if (track.liked) {
        popupLikeBtn.style.color = '#ff0000';
        popupLikeBtn.classList.add('liked');
      } else {
        popupLikeBtn.style.color = '#b3b3b3';
        popupLikeBtn.classList.remove('liked');
      }
    }
    if (stickyLikeBtn) {
      stickyLikeBtn.style.color = track.liked ? '#ff0000' : '#b3b3b3';
    }

    playerAudio.src = track.base64;
    playerAudio.play().catch(console.error);
    isPlaying = true;

    // Update queue display if queue popup is open
    const queuePopup = document.getElementById('queuePopup');
    if (queuePopup && queuePopup.style.display === 'block') {
      updateQueueDisplay();
    }

    // showNotification(`Now playing: ${track.name}`, 'success'); // Removed notification
  }
};

// Enhanced toggle like function
window.toggleLike = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (track) {
    track.liked = !track.liked;
    saveTrackToDB(track);
    renderOfflineLibrary();

    const btn = document.querySelector(`button[onclick="toggleLike('${trackId}')"]`);
    if (btn) {
      btn.style.color = track.liked ? '#fff700' : '#ff4081';
    }

    showNotification(track.liked ? 'Added to liked!' : 'Removed from liked!', 'success');
  }
};

// Menu functions
window.toggleTrackMenu = function(trackId) {
  // Close all other menus
  document.querySelectorAll('.track-menu-popup').forEach(menu => {
    if (menu.id !== `menu-${trackId}`) menu.style.display = 'none';
  });

  const menu = document.getElementById(`menu-${trackId}`);
  if (menu) {
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }
};

window.likeTrack = function(trackId) {
  toggleLike(trackId);
  // Also add to global liked tracks for Liked25App.html
  try {
    const track = offlineTracks.find(t => t.id === trackId);
    if (track) {
      let likedTracks = JSON.parse(localStorage.getItem('hertz_liked_tracks') || '[]');
      // Prevent duplicates
      if (!likedTracks.some(t => t.id === track.id)) {
        likedTracks.unshift({
          id: track.id,
          name: track.name,
          artist: track.artist,
          url: track.url || '',
          likedAt: new Date().toISOString()
        });
        localStorage.setItem('hertz_liked_tracks', JSON.stringify(likedTracks));
        // Notify other tabs/pages
        localStorage.setItem('hertzLikedTracksUpdate', Date.now().toString());
      }
    }
  } catch (e) {
    console.error('Error syncing liked track to global storage:', e);
  }
  document.getElementById(`menu-${trackId}`).style.display = 'none';
};

window.addToQueue = function(trackId) {
  const track = offlineTracks.find(t => t.id === trackId);
  if (track && !queue.find(t => t.id === trackId)) {
    queue.push(track);
    showNotification('Added to queue!', 'success');
  }
  document.getElementById(`menu-${trackId}`).style.display = 'none';
};


window.removeTrack = function(trackId) {
  if (confirm('Are you sure you want to remove this track from your library?')) {
    offlineTracks = offlineTracks.filter(t => t.id !== trackId);
    queue = queue.filter(t => t.id !== trackId);
    selectedTracks.delete(trackId);

    // Remove from database
    initDB().then(db => {
      const transaction = db.transaction(['tracks'], 'readwrite');
      const store = transaction.objectStore('tracks');
      store.delete(trackId);
    }).catch(() => {
      localStorage.removeItem('hertz_track_' + trackId);
    });

    renderOfflineLibrary();
    showNotification('Track removed from library', 'success');
  }
  document.getElementById(`menu-${trackId}`).style.display = 'none';
};

console.log(' Complete enhanced offline system loaded');
  </script>

  <!-- Copyright Footer -->
  <footer style="position: relative; bottom: 0; left: 0; right: 0; background: rgba(24, 24, 24, 0.95); border-top: 1px solid #404040; padding: 12px 16px; text-align: center; font-size: 0.75rem; color: #b3b3b3; margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
      <div>
         2025 HZ Music Streamer. All rights reserved.
      </div>
      <div style="font-weight: 500; color: gold;">
        Founded & Developed by <span style="color: #fff;">Beniam Endale Tedla</span>
      </div>
    </div>
  </footer>
</body>
</html>
